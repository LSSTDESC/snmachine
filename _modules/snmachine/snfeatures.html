

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>snmachine.snfeatures &mdash; snmachine 1.0.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> snmachine
          

          
          </a>

          
            
            
              <div class="version">
                1.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation and Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pmodels.html">parametric_models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../snclassifier.html">snclassifier</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sndata.html">sndata</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../snfeatures.html">snfeatures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tsne_plot.html">tsne_plot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../parallel.html">Running on Clusters / in Parallel</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">snmachine</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>snmachine.snfeatures</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for snmachine.snfeatures</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module for feature extraction on supernova light curves.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">parametric_models</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">pywt</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">subprocess</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sncosmo</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="k">import</span> <span class="n">interp1d</span>
<span class="kn">import</span> <span class="nn">george</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="k">import</span> <span class="n">Table</span><span class="p">,</span> <span class="n">vstack</span><span class="p">,</span> <span class="n">hstack</span><span class="p">,</span> <span class="n">join</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="k">import</span> <span class="n">Pool</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">op</span>
<span class="kn">from</span> <span class="nn">iminuit</span> <span class="k">import</span> <span class="n">Minuit</span><span class="p">,</span> <span class="n">describe</span>
<span class="kn">import</span> <span class="nn">traceback</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pymultinest</span>
    <span class="kn">from</span> <span class="nn">pymultinest.analyse</span> <span class="k">import</span> <span class="n">Analyzer</span>
    <span class="n">has_multinest</span><span class="o">=</span><span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">has_multinest</span><span class="o">=</span><span class="kc">False</span>
    
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">emcee</span>
    <span class="n">has_emcee</span><span class="o">=</span><span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">has_emcee</span><span class="o">=</span><span class="kc">False</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">george</span>
    <span class="n">has_george</span><span class="o">=</span><span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">has_george</span><span class="o">=</span><span class="kc">False</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">gapp</span> <span class="k">import</span> <span class="n">dgp</span>
    <span class="n">has_gapp</span><span class="o">=</span><span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">has_gapp</span><span class="o">=</span><span class="kc">False</span>

<span class="k">def</span> <span class="nf">_GP</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">ngp</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">initheta</span><span class="p">,</span> <span class="n">save_output</span><span class="p">,</span> <span class="n">output_root</span><span class="p">,</span> <span class="n">gpalgo</span><span class="o">=</span><span class="s1">&#39;george&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fit a Gaussian process curve at specific evenly spaced points along a light curve.</span>

<span class="sd">    iarameters</span>
<span class="sd">    ----------</span>
<span class="sd">    obj : str</span>
<span class="sd">        Name of the object</span>
<span class="sd">    d : Dataset-like object</span>
<span class="sd">        Dataset</span>
<span class="sd">    ngp : int</span>
<span class="sd">        Number of points to evaluate Gaussian Process at</span>
<span class="sd">    xmin : float</span>
<span class="sd">        Minimim time to evaluate at</span>
<span class="sd">    xmax : float</span>
<span class="sd">        Maximum time to evaluate at</span>
<span class="sd">    initheta : list-like</span>
<span class="sd">        Initial values for theta parameters. These should be roughly the scale length in the y &amp; x directions.</span>
<span class="sd">    save_output : bool</span>
<span class="sd">        Whether or not to save the output</span>
<span class="sd">    output_root : str</span>
<span class="sd">        Output directory</span>
<span class="sd">    gpalgo : str</span>
<span class="sd">        which gp package is used for the Gaussian Process Regression, GaPP or george</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    astropy.table.Table</span>
<span class="sd">        Table with evaluated Gaussian process curve and errors</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">gpalgo</span><span class="o">==</span><span class="s1">&#39;gapp&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_gapp</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No GP module gapp. Defaulting to george instead.&#39;</span><span class="p">)</span>
        <span class="n">gpalgo</span><span class="o">=</span><span class="s1">&#39;george&#39;</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">lc</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span>
    <span class="n">filters</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">])</span>
    <span class="c1">#Store the output in another astropy table</span>
    <span class="n">output</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">fil</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">filter_set</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fil</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
            <span class="n">x</span><span class="o">=</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;mjd&#39;</span><span class="p">][</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">fil</span><span class="p">]</span>
            <span class="n">y</span><span class="o">=</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">][</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">fil</span><span class="p">]</span>
            <span class="n">err</span><span class="o">=</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;flux_error&#39;</span><span class="p">][</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">fil</span><span class="p">]</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">gpalgo</span><span class="o">==</span><span class="s1">&#39;gapp&#39;</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
                <span class="n">g</span><span class="o">=</span><span class="n">dgp</span><span class="o">.</span><span class="n">DGaussianProcess</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">cXstar</span><span class="o">=</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ngp</span><span class="p">))</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">__stdout__</span>
                <span class="n">rec</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="n">g</span><span class="o">.</span><span class="n">gp</span><span class="p">(</span><span class="n">theta</span><span class="o">=</span><span class="n">initheta</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">gpalgo</span><span class="o">==</span><span class="s1">&#39;george&#39;</span><span class="p">:</span>
                <span class="c1"># Define the objective function (negative log-likelihood in this case).</span>
                <span class="k">def</span> <span class="nf">nll</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">set_parameter_vector</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                    <span class="n">ll</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">log_likelihood</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">return</span> <span class="o">-</span><span class="n">ll</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span> <span class="k">else</span> <span class="mf">1e25</span>

                <span class="c1"># And the gradient of the objective function.</span>
                <span class="k">def</span> <span class="nf">grad_nll</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">set_parameter_vector</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                    <span class="k">return</span> <span class="o">-</span><span class="n">g</span><span class="o">.</span><span class="n">grad_log_likelihood</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

      <span class="c1">#          sys.stdout = open(os.devnull, &quot;w&quot;)</span>
                <span class="n">g</span><span class="o">=</span><span class="n">george</span><span class="o">.</span><span class="n">GP</span><span class="p">(</span><span class="n">initheta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">george</span><span class="o">.</span><span class="n">kernels</span><span class="o">.</span><span class="n">ExpSquaredKernel</span><span class="p">(</span><span class="n">metric</span><span class="o">=</span><span class="n">initheta</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                <span class="n">g</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">err</span><span class="p">)</span>
                <span class="n">p0</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_parameter_vector</span><span class="p">()</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">nll</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">jac</span><span class="o">=</span><span class="n">grad_nll</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;L-BFGS-B&quot;</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">set_parameter_vector</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
       <span class="c1">#         sys.stdout=sys.__stdout__</span>
                <span class="n">xstar</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span><span class="n">xmax</span><span class="p">,</span><span class="n">ngp</span><span class="p">)</span>
                <span class="n">mu</span><span class="p">,</span><span class="n">cov</span><span class="o">=</span><span class="n">g</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">xstar</span><span class="p">)</span>
                <span class="n">std</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cov</span><span class="p">))</span>
                <span class="n">rec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">xstar</span><span class="p">,</span><span class="n">mu</span><span class="p">,</span><span class="n">std</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ngp</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
        <span class="n">newtable</span><span class="o">=</span><span class="n">Table</span><span class="p">([</span><span class="n">rec</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">rec</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">rec</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="n">fil</span><span class="p">]</span><span class="o">*</span><span class="n">ngp</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mjd&#39;</span><span class="p">,</span> <span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;flux_error&#39;</span><span class="p">,</span> <span class="s1">&#39;filter&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">output</span><span class="o">=</span><span class="n">newtable</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span><span class="o">=</span><span class="n">vstack</span><span class="p">((</span><span class="n">output</span><span class="p">,</span> <span class="n">newtable</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">save_output</span><span class="o">==</span><span class="s1">&#39;gp&#39;</span> <span class="ow">or</span> <span class="n">save_output</span><span class="o">==</span><span class="s1">&#39;all&#39;</span><span class="p">:</span>
        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_root</span><span class="p">,</span> <span class="s1">&#39;gp_&#39;</span><span class="o">+</span><span class="n">obj</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>        
    <span class="k">return</span> <span class="n">output</span>



<span class="k">def</span> <span class="nf">_run_leastsq</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">n_attempts</span><span class="p">,</span> <span class="n">seed</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Minimises the chi2 on all the filter bands of a given light curve, fitting the model to each one and extracting</span>
<span class="sd">    the best fitting parameters</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    obj : str</span>
<span class="sd">        Object name</span>
<span class="sd">    d : Dataset</span>
<span class="sd">        Dataset object</span>
<span class="sd">    model : parametric model object</span>
<span class="sd">        Parametric model</span>
<span class="sd">    n_attempts : int</span>
<span class="sd">        We run this multiple times to try to avoid local minima and take the best fitting values.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    astropy.table.Table</span>
<span class="sd">        Table of best fitting parameters for all filters</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lc</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span>
    <span class="n">filts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">])</span>

    <span class="n">n_params</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param_names</span><span class="p">)</span>

    <span class="c1">#How many times to keep trying to fit each object to obtain a good fit (defined as reduced chi2 of less than 2)</span>
    <span class="k">if</span> <span class="n">n_attempts</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">n_attempts</span><span class="o">=</span><span class="mi">1</span>

    <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Object&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">filter_set</span><span class="p">:</span>
        <span class="n">pams</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">param_names</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pams</span><span class="p">:</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">+</span><span class="s1">&#39;-&#39;</span><span class="o">+</span><span class="n">p</span><span class="p">)</span>
    <span class="n">output</span><span class="o">=</span><span class="n">Table</span><span class="p">(</span><span class="n">names</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;U32&#39;</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">seed</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

    <span class="n">t1</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">row</span><span class="o">=</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">filter_set</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filts</span><span class="p">:</span>
            <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;mjd&#39;</span><span class="p">][</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">f</span><span class="p">])</span>
            <span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">][</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">f</span><span class="p">])</span>
            <span class="n">err</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;flux_error&#39;</span><span class="p">][</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">f</span><span class="p">])</span>

            <span class="k">def</span> <span class="nf">mini_func</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">):</span>
                <span class="c1">#This function changes with each object so is necessary to redefine (since you can&#39;t pass arguments through Minuit)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)):</span>
                    <span class="n">p</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">p</span><span class="o">&lt;</span><span class="n">model</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">p</span><span class="o">&gt;</span><span class="n">model</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                <span class="n">ynew</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
                <span class="n">chi2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">ynew</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">ynew</span><span class="p">)</span><span class="o">/</span><span class="n">err</span><span class="o">/</span><span class="n">err</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">chi2</span>

            <span class="c1">#For the sake of speed, we stop as soon as we get to reduced chi2&lt;2, failing that we use the</span>
            <span class="c1">#best fit found so far</span>
            <span class="n">fmin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="n">min_params</span><span class="o">=</span><span class="p">[]</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_attempts</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="c1">#Try the default starting point</span>
                    <span class="n">input_args</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">initial</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">#Pick a new, random starting point</span>
                    <span class="n">input_args</span><span class="o">=</span><span class="p">{}</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">param_names</span><span class="p">:</span>
                        <span class="n">val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">model</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">input_args</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">=</span><span class="n">val</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">param_names</span><span class="p">:</span>
                    <span class="n">input_args</span><span class="p">[</span><span class="s1">&#39;limit_&#39;</span><span class="o">+</span><span class="n">p</span><span class="p">]</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>

                <span class="n">m</span><span class="o">=</span><span class="n">Minuit</span><span class="p">(</span><span class="n">mini_func</span><span class="p">,</span> <span class="n">pedantic</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">print_level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">forced_parameters</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">param_names</span><span class="p">,</span> <span class="o">**</span><span class="n">input_args</span><span class="p">)</span>

                <span class="n">m</span><span class="o">.</span><span class="n">migrad</span><span class="p">()</span>
                <span class="n">parm</span><span class="o">=</span><span class="p">[]</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">param_names</span><span class="p">:</span>
                    <span class="n">parm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">p</span><span class="p">])</span>

                <span class="n">rchi2</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">fval</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">rchi2</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">:</span>
                    <span class="n">fmin</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">fval</span>
                    <span class="n">min_params</span><span class="o">=</span><span class="n">parm</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="n">m</span><span class="o">.</span><span class="n">fval</span><span class="o">&lt;</span><span class="n">fmin</span><span class="p">:</span>
                    <span class="n">fmin</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">fval</span>
                    <span class="n">min_params</span><span class="o">=</span><span class="n">parm</span>

            <span class="n">outfl</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
            <span class="n">outfl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%f</span><span class="se">\t</span><span class="si">%d</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">fmin</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">i</span><span class="p">))</span>
            <span class="n">outfl</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">row</span><span class="o">+=</span><span class="n">min_params</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">row</span><span class="o">+=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param_names</span><span class="p">)</span> <span class="c1">#Fill missing values with zeros</span>
    <span class="n">output</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
    <span class="c1">#print &#39;Time per filter&#39;, (time.time()-t1)/4</span>
    <span class="k">return</span> <span class="n">output</span>





<span class="k">def</span> <span class="nf">_run_multinest</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">chain_directory</span><span class="p">,</span>  <span class="n">nlp</span><span class="p">,</span> <span class="n">convert_to_binary</span><span class="p">,</span> <span class="n">n_iter</span><span class="p">,</span> <span class="n">restart</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">seed</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs multinest on all the filter bands of a given light curve, fitting the model to each one and</span>
<span class="sd">    extracting the best fitting parameters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    obj : str</span>
<span class="sd">        Object name</span>
<span class="sd">    d : Dataset</span>
<span class="sd">        Dataset object</span>
<span class="sd">    model : parametric model object</span>
<span class="sd">        Parametric model</span>
<span class="sd">    chain_directory : str</span>
<span class="sd">        Path to where the output files go</span>
<span class="sd">    nlp : int</span>
<span class="sd">        Number of live points</span>
<span class="sd">    convert_to_binary : bool</span>
<span class="sd">        Whether or not to convert the ascii output files to binary</span>
<span class="sd">    n_iter : int</span>
<span class="sd">        Maximum number of iterations</span>
<span class="sd">    restart : bool</span>
<span class="sd">        Whether to restart from existing chain files.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    astropy.table.Table</span>
<span class="sd">        Table of best fitting parameters and their errors for all filters</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">prior_multinest</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">nparams</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Prior function specifically for multinest. This would be called for one filter, for one object.</span>
<span class="sd">            @param cube A ctypes pointer to the parameter cube (actually just the current parameter values).</span>
<span class="sd">            @param ndim Number of dimensions</span>
<span class="sd">            @param nparams Number of parameters. Usually the same as ndim unless you have unsampled (e.g. calculated) parameters. These</span>
<span class="sd">            are assumed to be the first (ndim-nparams) parameters.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">up</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">upper_limit</span>
            <span class="n">low</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">lower_limit</span>
            
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nparams</span><span class="p">):</span>
                <span class="n">cube</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">cube</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">up</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">low</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="n">low</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">cube</span>
            
            
        <span class="n">lc</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span>
        <span class="n">filts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">])</span>
        
        <span class="n">n_params</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param_names</span><span class="p">)</span>
        
        <span class="c1">#err_plus=[pname+&#39;_err+&#39; for pname in self.model.param_names]</span>
        <span class="c1">#err_minus=[pname+&#39;_err-&#39; for pname in self.model.param_names]</span>
        <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Object&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">filter_set</span><span class="p">:</span>
            <span class="n">pams</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">param_names</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pams</span><span class="p">:</span>
                <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">+</span><span class="s1">&#39;-&#39;</span><span class="o">+</span><span class="n">p</span><span class="p">)</span>

        <span class="n">output</span><span class="o">=</span><span class="n">Table</span><span class="p">(</span><span class="n">names</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;U32&#39;</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    
        
        <span class="n">row</span><span class="o">=</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">filter_set</span><span class="p">:</span>
            <span class="n">t1</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filts</span><span class="p">:</span>
                <span class="c1">#current values for x,y and err are set each time multinest is called</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;mjd&#39;</span><span class="p">][</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">f</span><span class="p">],</span> <span class="n">lc</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">][</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">f</span><span class="p">],</span> <span class="n">lc</span><span class="p">[</span><span class="s1">&#39;flux_error&#39;</span><span class="p">][</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">f</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span>
                
                <span class="k">def</span> <span class="nf">loglike_multinest</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">nparams</span><span class="p">):</span>
                    <span class="sd">&quot;&quot;&quot;Loglikelihood function specifically for multinest. This would be called for one filter, for one object.</span>
<span class="sd">                    @param cube A ctypes pointer to the parameter cube (actually just the current parameter values).</span>
<span class="sd">                    @param ndim Number of dimensions</span>
<span class="sd">                    @param nparams Number of parameters. Usually the same as ndim unless you have unsampled (e.g. calculated) parameters. These</span>
<span class="sd">                    are assumed to be the first (ndim-nparams) parameters.</span>
<span class="sd">                    &quot;&quot;&quot;</span>
                    <span class="n">params</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nparams</span><span class="p">)</span>
                    <span class="c1">#This is the only obvious way to convert a ctypes pointer to a numpy array</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nparams</span><span class="p">):</span>
                        <span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">cube</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="c1">#params=[ 26.97634888,   45.13123322,    2.59183478,    0.12057552,    7.65392637]</span>
                    <span class="n">ynew</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
                    
                    <span class="n">chi2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(((</span><span class="n">y</span><span class="o">-</span><span class="n">ynew</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">ynew</span><span class="p">))</span><span class="o">/</span><span class="n">err</span><span class="o">/</span><span class="n">err</span><span class="p">)</span>
                    <span class="c1">#print &#39;likelihood&#39;, -chi2/2.</span>
                    <span class="k">return</span> <span class="o">-</span><span class="n">chi2</span><span class="o">/</span><span class="mf">2.</span>
                
                <span class="n">chain_name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chain_directory</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">f</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">model_name</span><span class="p">))</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="n">restart</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">chain_name</span><span class="o">+</span><span class="s1">&#39;stats.dat&#39;</span><span class="p">):</span>
                    <span class="c1">#Gives the ability to restart from existing chains if they exist</span>
                    <span class="n">pymultinest</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">loglike_multinest</span><span class="p">,</span> <span class="n">prior_multinest</span><span class="p">,</span> <span class="n">n_params</span><span class="p">,</span> <span class="n">importance_nested_sampling</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">init_MPI</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                    <span class="n">resume</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">sampling_efficiency</span> <span class="o">=</span> <span class="s1">&#39;parameter&#39;</span><span class="p">,</span> <span class="n">n_live_points</span> <span class="o">=</span> <span class="n">nlp</span><span class="p">,</span> <span class="n">outputfiles_basename</span><span class="o">=</span><span class="n">chain_name</span><span class="p">,</span> 
                    <span class="n">multimodal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="n">n_iter</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
                    
                <span class="c1">#An=Analyzer(n_params, chain_name)</span>
                <span class="c1">#best_params=An.get_best_fit()[&#39;parameters&#39;]</span>
                
<span class="c1">#                chain=np.loadtxt(chain_name+&#39;.txt&#39;)</span>
<span class="c1">#                best_params=np.median(chain, axis=0)[2:]</span>
                <span class="n">best_params</span><span class="o">=</span><span class="n">get_MAP</span><span class="p">(</span><span class="n">chain_name</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">convert_to_binary</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">restart</span><span class="p">:</span>
                    <span class="n">s</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">f</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">model_name</span><span class="p">)</span>
                    <span class="n">ext</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ev.dat&#39;</span><span class="p">,</span> <span class="s1">&#39;phys_live.points&#39;</span><span class="p">,</span> <span class="s1">&#39;live.points&#39;</span><span class="p">,</span> <span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;post_equal_weights.dat&#39;</span><span class="p">]</span> <span class="c1">#These are the files we can convert</span>
                    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">ext</span><span class="p">:</span>
                        <span class="n">infile</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chain_directory</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">f</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                        <span class="n">outfile</span><span class="o">=</span><span class="n">infile</span><span class="o">+</span><span class="s1">&#39;.npy&#39;</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">infile</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;ERROR reading file&#39;</span><span class="p">,</span> <span class="n">infile</span><span class="p">)</span>
                            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;File unconverted&#39;</span><span class="p">)</span>
    <span class="c1">#            stats=An.get_stats()[&#39;marginals&#39;]</span>
    <span class="c1">#            sig_upper=[stats[p][&#39;1sigma&#39;][1]-best_params[p] for p in range(len(stats))]</span>
    <span class="c1">#            sig_lower=[best_params[p]-stats[p][&#39;1sigma&#39;][0] for p in range(len(stats))]</span>
    <span class="c1">#            best=best_params+sig_lower+sig_upper</span>
                <span class="c1">#Expects first the parameters, then -sigma then +sigma</span>

                <span class="n">row</span><span class="o">+=</span><span class="n">best_params</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">row</span><span class="o">+=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param_names</span><span class="p">)</span> <span class="c1">#I&#39;m not sure if it makes the most sense to fill in missing values with zeroes...</span>
            <span class="c1">#print &#39;Time for object&#39;, obj, &#39;filter&#39;, f,&#39;:&#39;, (time.time()-t1)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chain_directory</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-.time&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">f</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">model_name</span><span class="p">)),</span> <span class="p">[</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t1</span><span class="p">])</span>
            
        <span class="n">output</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">output</span>
    
    <span class="k">except</span><span class="p">:</span>
        <span class="c1">#Sometimes things just break</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;ERROR in&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
        <span class="nb">print</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="nb">print</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_tb</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span>
        
        <span class="k">return</span> <span class="kc">None</span>
        

    
    
<span class="k">def</span> <span class="nf">_run_leastsq_templates</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">use_redshift</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">seed</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fit template-based supernova models using least squares.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    obj : str</span>
<span class="sd">        Object name</span>
<span class="sd">    d : Dataset</span>
<span class="sd">        Dataset object</span>
<span class="sd">    model_name : str</span>
<span class="sd">        Name of model to use (to be passed to sncosmo)</span>
<span class="sd">    use_redshift : bool</span>
<span class="sd">        Whether or not to use provided redshift information</span>
<span class="sd">    bounds : dict</span>
<span class="sd">        Bounds on parameters</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    astropy.table.Table</span>
<span class="sd">        Table of best fitting parameters</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">lc</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">model_name</span><span class="o">==</span><span class="s1">&#39;mlcs2k2&#39;</span><span class="p">:</span>
        <span class="n">dust</span><span class="o">=</span><span class="n">sncosmo</span><span class="o">.</span><span class="n">CCM89Dust</span><span class="p">()</span>
        <span class="n">model</span><span class="o">=</span><span class="n">sncosmo</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span><span class="n">effects</span><span class="o">=</span><span class="p">[</span><span class="n">dust</span><span class="p">],</span><span class="n">effect_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">],</span> <span class="n">effect_frames</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;rest&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">model</span><span class="o">=</span><span class="n">sncosmo</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>


    <span class="c1">#labels=[&#39;Object&#39;]+model.param_names+[&#39;Chisq&#39;]</span>
    <span class="c1">#output=Table(names=labels, dtype=[&#39;S32&#39;]+[&#39;f&#39;]*(len(model.param_names))+[&#39;f&#39;])</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Object&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">param_names</span>
    <span class="n">output</span><span class="o">=</span><span class="n">Table</span><span class="p">(</span><span class="n">names</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;U32&#39;</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param_names</span><span class="p">)))</span>

    <span class="n">t1</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">row</span><span class="o">=</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">use_redshift</span><span class="p">:</span>
        <span class="n">model</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">lc</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">])</span>
        <span class="n">prms</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">param_names</span>
        <span class="n">prms</span><span class="o">=</span><span class="n">prms</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">bnds</span><span class="o">=</span><span class="n">bounds</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">bnds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">res</span><span class="p">,</span> <span class="n">fitted_model</span><span class="o">=</span><span class="n">sncosmo</span><span class="o">.</span><span class="n">fit_lc</span><span class="p">(</span><span class="n">lc</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">vparam_names</span><span class="o">=</span><span class="n">prms</span><span class="p">,</span>
            <span class="n">bounds</span><span class="o">=</span><span class="n">bnds</span><span class="p">,</span> <span class="n">minsnr</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res</span><span class="p">,</span> <span class="n">fitted_model</span><span class="o">=</span><span class="n">sncosmo</span><span class="o">.</span><span class="n">fit_lc</span><span class="p">(</span><span class="n">lc</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">vparam_names</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">param_names</span><span class="p">,</span>
            <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">minsnr</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">best</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">]</span>
    <span class="n">best</span><span class="o">=</span><span class="n">best</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">row</span><span class="o">+=</span><span class="n">best</span>
    <span class="c1">#row+=[res[&#39;chisq&#39;]]</span>

    <span class="n">output</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output</span>
        

<span class="k">def</span> <span class="nf">_run_multinest_templates</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">chain_directory</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span>  <span class="n">nlp</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">convert_to_binary</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_redshift</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">short_name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">restart</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">seed</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Fit template-based supernova models using multinest.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    obj : str</span>
<span class="sd">        Object name</span>
<span class="sd">    d : Dataset</span>
<span class="sd">        Dataset object</span>
<span class="sd">    model_name : str</span>
<span class="sd">        Name of model to use (to be passed to sncosmo)</span>
<span class="sd">    use_redshift : bool</span>
<span class="sd">        Whether or not to use provided redshift information</span>
<span class="sd">    bounds : dict</span>
<span class="sd">        Bounds on parameters</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    astropy.table.Table</span>
<span class="sd">        Table of best fitting parameters</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    obj : str</span>
<span class="sd">        Object name</span>
<span class="sd">    d : Dataset</span>
<span class="sd">        Dataset object</span>
<span class="sd">    model_name : str</span>
<span class="sd">        Name of model to use (to be passed to sncosmo)</span>
<span class="sd">    bounds : dict</span>
<span class="sd">        Bounds on parameters</span>
<span class="sd">    chain_directory : str</span>
<span class="sd">        Path to output directory for chains</span>
<span class="sd">    nlp : int</span>
<span class="sd">        Number of live points</span>
<span class="sd">    convert_to_binary : bool</span>
<span class="sd">        Whether or not to convert ascii Multinest files to binary</span>
<span class="sd">    use_redshift : bool</span>
<span class="sd">        Whether or not to use provided redshift information</span>
<span class="sd">    short_name : str</span>
<span class="sd">        A shorter name for the chains (to overcome Multinest&#39;s character limitation)</span>
<span class="sd">    restart : bool</span>
<span class="sd">        Whether or not to restart from existing chains</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array-like</span>
<span class="sd">        List of best-fitting parameters</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">prior_multinest</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">nparams</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Prior function specifically for multinest. This would be called for one filter, for one object.</span>
<span class="sd">            @param cube A ctypes pointer to the parameter cube (actually just the current parameter values).</span>
<span class="sd">            @param ndim Number of dimensions</span>
<span class="sd">            @param nparams Number of parameters. Usually the same as ndim unless you have unsampled (e.g. calculated) parameters. These</span>
<span class="sd">            are assumed to be the first (ndim-nparams) parameters.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="n">params</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">param_names</span>
            <span class="k">if</span> <span class="n">use_redshift</span><span class="p">:</span>
                <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">):</span>
                <span class="n">p</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">cube</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">cube</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">bounds</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="n">bounds</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">cube</span>

        <span class="k">def</span> <span class="nf">loglike_multinest</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">nparams</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Loglikelihood function specifically for multinest. This would be called for one filter, for one object.</span>
<span class="sd">            @param cube A ctypes pointer to the parameter cube (actually just the current parameter values).</span>
<span class="sd">            @param ndim Number of dimensions</span>
<span class="sd">            @param nparams Number of parameters. Usually the same as ndim unless you have unsampled (e.g. calculated) parameters. These</span>
<span class="sd">            are assumed to be the first (ndim-nparams) parameters.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">dic</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># This is the only obvious way to convert a ctypes pointer to a numpy array</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">param_names</span>
            <span class="k">if</span> <span class="n">use_redshift</span><span class="p">:</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lc</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nparams</span><span class="p">):</span>
                <span class="n">dic</span><span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cube</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="n">model</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="n">dic</span><span class="p">)</span>
            <span class="n">chi2</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="n">filts</span><span class="p">:</span>
                <span class="n">yfit</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">bandflux</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="n">X</span><span class="p">[</span><span class="n">filt</span><span class="p">],</span> <span class="n">zp</span><span class="o">=</span><span class="mf">27.5</span><span class="p">,</span> <span class="n">zpsys</span><span class="o">=</span><span class="s1">&#39;ab&#39;</span><span class="p">)</span>
                <span class="n">chi2</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(((</span><span class="n">Y</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span> <span class="o">-</span> <span class="n">yfit</span><span class="p">)</span> <span class="o">/</span> <span class="n">E</span><span class="p">[</span><span class="n">filt</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">chi2</span> <span class="o">/</span> <span class="mf">2.</span>

        <span class="n">lc</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span>
        <span class="n">filts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">model_name</span><span class="o">==</span><span class="s1">&#39;mlcs2k2&#39;</span><span class="p">:</span>
            <span class="n">dust</span><span class="o">=</span><span class="n">sncosmo</span><span class="o">.</span><span class="n">CCM89Dust</span><span class="p">()</span>
            <span class="n">model</span><span class="o">=</span><span class="n">sncosmo</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span><span class="n">effects</span><span class="o">=</span><span class="p">[</span><span class="n">dust</span><span class="p">],</span><span class="n">effect_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">],</span> <span class="n">effect_frames</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;rest&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model</span><span class="o">=</span><span class="n">sncosmo</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
        
        <span class="n">n_params</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param_names</span><span class="p">)</span>
        
        <span class="c1">#err_plus=[pname+&#39;_err+&#39; for pname in self.model.param_names]</span>
        <span class="c1">#err_minus=[pname+&#39;_err-&#39; for pname in self.model.param_names]</span>
        <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Object&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">model</span><span class="o">.</span><span class="n">param_names</span>
        
        <span class="n">t1</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        
        <span class="c1">#Convert the astropy table to numpy array outside the likelihood function to avoid repeated calls</span>
        <span class="n">X</span><span class="o">=</span><span class="p">{}</span>
        <span class="n">Y</span><span class="o">=</span><span class="p">{}</span>
        <span class="n">E</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="n">filts</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;mjd&#39;</span><span class="p">][</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">filt</span><span class="p">],</span> <span class="n">lc</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">][</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">filt</span><span class="p">],</span> <span class="n">lc</span><span class="p">[</span><span class="s1">&#39;flux_error&#39;</span><span class="p">][</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">filt</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span>
            <span class="n">X</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span><span class="o">=</span><span class="n">x</span>
            <span class="n">Y</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span><span class="o">=</span><span class="n">y</span>
            <span class="n">E</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span><span class="o">=</span><span class="n">err</span>
        

        
        <span class="n">chain_name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chain_directory</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">short_name</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">use_redshift</span><span class="p">:</span>
            <span class="n">ndim</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param_names</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ndim</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param_names</span><span class="p">)</span>
        
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">restart</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">chain_name</span><span class="o">+</span><span class="s1">&#39;stats.dat&#39;</span><span class="p">):</span>
            <span class="n">pymultinest</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">loglike_multinest</span><span class="p">,</span> <span class="n">prior_multinest</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">importance_nested_sampling</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">init_MPI</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">resume</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">sampling_efficiency</span> <span class="o">=</span> <span class="s1">&#39;parameter&#39;</span><span class="p">,</span> <span class="n">n_live_points</span> <span class="o">=</span> <span class="n">nlp</span><span class="p">,</span> <span class="n">outputfiles_basename</span><span class="o">=</span><span class="n">chain_name</span><span class="p">,</span> 
            <span class="n">multimodal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
        
        <span class="n">best_params</span><span class="o">=</span><span class="n">get_MAP</span><span class="p">(</span><span class="n">chain_name</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">use_redshift</span><span class="p">:</span>
            <span class="n">best_params</span><span class="o">=</span><span class="p">[</span><span class="n">lc</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]]</span><span class="o">+</span><span class="n">best_params</span>
            

        <span class="k">if</span> <span class="n">convert_to_binary</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">restart</span><span class="p">:</span>
            <span class="n">s</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">short_name</span><span class="p">)</span>
            <span class="n">ext</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ev.dat&#39;</span><span class="p">,</span> <span class="s1">&#39;phys_live.points&#39;</span><span class="p">,</span> <span class="s1">&#39;live.points&#39;</span><span class="p">,</span> <span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;post_equal_weights.dat&#39;</span><span class="p">]</span> <span class="c1">#These are the files we can convert</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">ext</span><span class="p">:</span>
                <span class="n">infile</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chain_directory</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">short_name</span><span class="p">,</span>  <span class="n">e</span><span class="p">))</span>
                <span class="n">outfile</span><span class="o">=</span><span class="n">infile</span><span class="o">+</span><span class="s1">&#39;.npy&#39;</span>
                <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">infile</span><span class="p">)</span>
                

        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chain_directory</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-.time&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">short_name</span><span class="p">)),</span> <span class="p">[</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">best_params</span><span class="p">)</span>
    
    <span class="k">except</span><span class="p">:</span>
        <span class="c1">#Sometimes things just break</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;ERROR in&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
        <span class="nb">print</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="nb">print</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_tb</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span>
        
        <span class="k">return</span> <span class="kc">None</span>


<div class="viewcode-block" id="output_time"><a class="viewcode-back" href="../../snfeatures.html#snmachine.snfeatures.output_time">[docs]</a><span class="k">def</span> <span class="nf">output_time</span><span class="p">(</span><span class="n">tm</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple function to output the time nicely formatted.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tm : Input time in seconds.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">hrs</span> <span class="o">=</span> <span class="n">tm</span> <span class="o">/</span> <span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
    <span class="n">mins</span> <span class="o">=</span> <span class="n">tm</span> <span class="o">/</span> <span class="mi">60</span>
    <span class="n">secs</span> <span class="o">=</span> <span class="n">tm</span>
    <span class="k">if</span> <span class="n">hrs</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1"> hours&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hrs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mins</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1"> minutes&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mins</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">secs</span><span class="p">)</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Time taken is&#39;</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_MAP"><a class="viewcode-back" href="../../snfeatures.html#snmachine.snfeatures.get_MAP">[docs]</a><span class="k">def</span> <span class="nf">get_MAP</span><span class="p">(</span><span class="n">chain_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read maximum posterior parameters from a stats file of multinest.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    chain_name : str</span>
<span class="sd">        Root for the chain files</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list-like</span>
<span class="sd">        Best-fitting parameters</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stats_file</span> <span class="o">=</span> <span class="n">chain_name</span> <span class="o">+</span> <span class="s1">&#39;stats.dat&#39;</span>
    <span class="n">fl</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">stats_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span> <span class="k">if</span> <span class="s1">&#39;MAP&#39;</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="n">ind</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:]]</span>
    <span class="k">return</span> <span class="n">params</span></div>

<div class="viewcode-block" id="Features"><a class="viewcode-back" href="../../snfeatures.html#snmachine.snfeatures.Features">[docs]</a><span class="k">class</span> <span class="nc">Features</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Base class to define basic functionality for extracting features from supernova datasets. Users are not</span>
<span class="sd">    restricted to inheriting from this class, but any Features class must contain the functions extract_features</span>
<span class="sd">    and fit_sn.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p_limit</span><span class="o">=</span><span class="mf">0.05</span> <span class="c1">#At what point to we suggest a model has been a bad fit. </span>
        
    <span class="k">def</span> <span class="nf">extract_features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
        
    <span class="k">def</span> <span class="nf">fit_sn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
        
<div class="viewcode-block" id="Features.goodness_of_fit"><a class="viewcode-back" href="../../snfeatures.html#snmachine.snfeatures.Features.goodness_of_fit">[docs]</a>    <span class="k">def</span> <span class="nf">goodness_of_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test (for any feature set) how well the reconstruction from the features fits each of the objects in the dataset.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        d : Dataset</span>
<span class="sd">            Dataset object.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        astropy.table.Table</span>
<span class="sd">            Table with the reduced Chi2 for each object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">models</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Call Dataset.set_models first.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">filts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">object_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;filter&#39;</span><span class="p">])</span>
        <span class="n">filts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">filts</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">rcs</span><span class="o">=</span><span class="n">Table</span><span class="p">(</span><span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Object&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">filts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;U32&#39;</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;float64&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">filts</span><span class="p">))</span> <span class="c1">#Reduced chi2</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">object_names</span><span class="p">:</span>
            <span class="c1">#Go through each filter</span>
            <span class="n">chi2</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">lc</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span>
            <span class="n">mod</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="n">filts</span><span class="p">:</span>
                <span class="n">l</span><span class="o">=</span><span class="n">lc</span><span class="p">[</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">filt</span><span class="p">]</span>
                <span class="n">m</span><span class="o">=</span><span class="n">mod</span><span class="p">[</span><span class="n">mod</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">filt</span><span class="p">]</span>
                <span class="n">x</span><span class="o">=</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;mjd&#39;</span><span class="p">]</span>
                <span class="n">y</span><span class="o">=</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span>
                <span class="n">e</span><span class="o">=</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;flux_error&#39;</span><span class="p">]</span>
                <span class="n">xmod</span><span class="o">=</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;mjd&#39;</span><span class="p">]</span>
                <span class="n">ymod</span><span class="o">=</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span>
                <span class="c1">#Interpolate</span>
                <span class="n">fit</span><span class="o">=</span><span class="n">interp1d</span><span class="p">(</span><span class="n">xmod</span><span class="p">,</span> <span class="n">ymod</span><span class="p">)</span>
                <span class="n">yfit</span><span class="o">=</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">chi2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">((</span><span class="n">yfit</span><span class="o">-</span><span class="n">y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">e</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">rcs</span><span class="o">.</span><span class="n">add_row</span><span class="p">([</span><span class="n">obj</span><span class="p">]</span><span class="o">+</span><span class="n">chi2</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">rcs</span></div>

<div class="viewcode-block" id="Features.posterior_predictor"><a class="viewcode-back" href="../../snfeatures.html#snmachine.snfeatures.Features.posterior_predictor">[docs]</a>    <span class="k">def</span> <span class="nf">posterior_predictor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lc</span><span class="p">,</span> <span class="n">nparams</span><span class="p">,</span> <span class="n">chi2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes posterior predictive p-value to see if the model fits sufficient well.</span>
<span class="sd">        ***UNTESTED***</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lc : astropy.table.Table</span>
<span class="sd">            Light curve</span>
<span class="sd">        nparams : int</span>
<span class="sd">            The number of parameters in the model. For the wavelets, this will be the number of PCA coefficients. For the parametric</span>
<span class="sd">            models, this will be the number parameters per model multiplied by the number of filters. For the template models, this is simply the number</span>
<span class="sd">            of parameters in the model.</span>
<span class="sd">        chi2 : array-like</span>
<span class="sd">            An array of chi2 values for each set of parameter space in the parameter samples. This is easy to obtain as -2*loglikelihood output</span>
<span class="sd">            from a multinest or mcmc chain. For features such as the wavelets, this will have to be separately calculated by drawing thousands of curves</span>
<span class="sd">            consistent with the coefficients and their errors and then computing the chi2.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            The posterior predictive p-value. If this number is too close to 0 or 1 it implies the model is a poor fit.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#Count the number of data points over all filters.</span>
        <span class="n">ndata</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;mjd&#39;</span><span class="p">])</span>
        <span class="n">dof</span><span class="o">=</span><span class="n">ndata</span><span class="o">-</span><span class="n">nparams</span><span class="o">-</span><span class="mi">1</span>

        <span class="k">if</span> <span class="n">dof</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">dof</span><span class="o">=</span><span class="mi">1</span>
        <span class="n">chi2_limit</span><span class="o">=</span><span class="n">stats</span><span class="o">.</span><span class="n">chi2</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">p_limit</span><span class="p">,</span> <span class="n">dof</span><span class="p">)</span>
        <span class="nb">print</span> <span class="p">(</span><span class="n">chi2_limit</span><span class="p">)</span>
        <span class="nb">print</span> <span class="p">(</span><span class="n">chi2</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">chi2</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">chi2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">chi2</span><span class="p">)</span>
        <span class="n">p_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">chi2</span><span class="o">&gt;</span><span class="n">chi2_limit</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">chi2</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">p_value</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">p_limit</span><span class="p">:</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Model fit unsatisfactory, p value=&#39;</span><span class="p">,</span> <span class="n">p_value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">p_value</span></div>
    
<div class="viewcode-block" id="Features.convert_astropy_array"><a class="viewcode-back" href="../../snfeatures.html#snmachine.snfeatures.Features.convert_astropy_array">[docs]</a>    <span class="k">def</span> <span class="nf">convert_astropy_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tab</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience function to convert an astropy table (floats only) into a numpy array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out_array</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tab</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tab</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="k">return</span> <span class="n">out_array</span></div></div>

        
<div class="viewcode-block" id="TemplateFeatures"><a class="viewcode-back" href="../../snfeatures.html#snmachine.snfeatures.TemplateFeatures">[docs]</a><span class="k">class</span> <span class="nc">TemplateFeatures</span><span class="p">(</span><span class="n">Features</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calls sncosmo to fit a variety of templates to the data. The number of features will depend on the templates </span>
<span class="sd">    chosen (e.g. salt2, nugent2p etc.)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Ia&#39;</span><span class="p">],</span> <span class="n">sampler</span><span class="o">=</span><span class="s1">&#39;leastsq&#39;</span><span class="p">,</span><span class="n">lsst_bands</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">lsst_dir</span><span class="o">=</span><span class="s1">&#39;../lsst_bands/&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        To initialise, provide a list of models to fit for (defaults to salt2 Ia templates).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model : list-like, optional</span>
<span class="sd">            List of models. In theory you can fit Ia and non-Ia models and use all those as features. So far only tested with SALT2.</span>
<span class="sd">        sampler : str, optional</span>
<span class="sd">            A choice of &#39;mcmc&#39;, which uses the emcee sampler, or &#39;multinest&#39; or &#39;leastsq&#39; (default).</span>
<span class="sd">        lsst_bands : bool, optional</span>
<span class="sd">            Whether or not the LSST bands are required. Only need for LSST simulations to register bands with sncosmo.</span>
<span class="sd">        lsst_dir : str, optional</span>
<span class="sd">            Directory where LSST bands are stored.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">Features</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lsst_bands</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">registerBands</span><span class="p">(</span><span class="n">lsst_dir</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;approxLSST_&#39;</span><span class="p">,</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;_total.dat&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_names</span><span class="o">=</span><span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">templates</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Ia&#39;</span><span class="p">:</span><span class="s1">&#39;salt2-extended&#39;</span><span class="p">,</span><span class="s1">&#39;salt2&#39;</span><span class="p">:</span><span class="s1">&#39;salt2-extended&#39;</span><span class="p">,</span> <span class="s1">&#39;mlcs2k2&#39;</span><span class="p">:</span><span class="s1">&#39;mlcs2k2&#39;</span><span class="p">,</span> <span class="s1">&#39;II&#39;</span><span class="p">:</span><span class="s1">&#39;nugent-sn2n&#39;</span><span class="p">,</span><span class="s1">&#39;IIn&#39;</span><span class="p">:</span><span class="s1">&#39;nugent-sn2n&#39;</span><span class="p">,</span><span class="s1">&#39;IIp&#39;</span><span class="p">:</span><span class="s1">&#39;nugent-sn2p&#39;</span><span class="p">,</span> <span class="s1">&#39;IIl&#39;</span><span class="p">:</span><span class="s1">&#39;nugent-sn2l&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Ibc&#39;</span><span class="p">:</span><span class="s1">&#39;nugent-sn1bc&#39;</span><span class="p">,</span>  <span class="s1">&#39;Ib&#39;</span><span class="p">:</span><span class="s1">&#39;nugent-sn1bc&#39;</span><span class="p">,</span>  <span class="s1">&#39;Ic&#39;</span><span class="p">:</span><span class="s1">&#39;nugent-sn1bc&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">short_names</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Ia&#39;</span><span class="p">:</span><span class="s1">&#39;salt2&#39;</span><span class="p">,</span> <span class="s1">&#39;mlcs2k2&#39;</span><span class="p">:</span><span class="s1">&#39;mlcs&#39;</span><span class="p">}</span> <span class="c1">#Short names because of limitations in Multinest</span>
        <span class="k">if</span> <span class="n">sampler</span><span class="o">==</span><span class="s1">&#39;nested&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">pymultinest</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Nested sampling selected but pymultinest is not installed. Defaulting to least squares.&#39;</span><span class="p">)</span>
                <span class="n">sampler</span><span class="o">=</span><span class="s1">&#39;leastsq&#39;</span>
        <span class="k">elif</span> <span class="n">sampler</span><span class="o">==</span><span class="s1">&#39;mcmc&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">emcee</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;MCMC sampling selected but emcee is not installed. Defaulting to least squares.&#39;</span><span class="p">)</span>
                <span class="n">sampler</span><span class="o">=</span><span class="s1">&#39;leastsq&#39;</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">sampler</span><span class="o">=</span><span class="n">sampler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;salt2-extended&#39;</span><span class="p">:{</span><span class="s1">&#39;z&#39;</span><span class="p">:(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">),</span> <span class="s1">&#39;t0&#39;</span><span class="p">:(</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">),</span><span class="s1">&#39;x0&#39;</span><span class="p">:(</span><span class="o">-</span><span class="mf">1e-3</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">),</span> <span class="s1">&#39;x1&#39;</span><span class="p">:(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="s1">&#39;c&#39;</span><span class="p">:(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)},</span> 
                    <span class="s1">&#39;mlcs2k2&#39;</span><span class="p">:{</span><span class="s1">&#39;z&#39;</span><span class="p">:(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">),</span> <span class="s1">&#39;t0&#39;</span><span class="p">:(</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">),</span> <span class="s1">&#39;amplitude&#39;</span><span class="p">:(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1e-17</span><span class="p">),</span> <span class="s1">&#39;delta&#39;</span><span class="p">:(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">1.8</span><span class="p">),</span><span class="s1">&#39;hostebv&#39;</span><span class="p">:(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span><span class="s1">&#39;hostr_v&#39;</span><span class="p">:(</span><span class="o">-</span><span class="mf">7.0</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">)},</span> 
                    <span class="s1">&#39;nugent-sn2n&#39;</span><span class="p">:{</span><span class="s1">&#39;z&#39;</span><span class="p">:(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)},</span> 
                    <span class="s1">&#39;nugent-sn2p&#39;</span><span class="p">:{</span><span class="s1">&#39;z&#39;</span><span class="p">:(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)},</span> 
                    <span class="s1">&#39;nugent-sn2l&#39;</span><span class="p">:{</span><span class="s1">&#39;z&#39;</span><span class="p">:(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)},</span> 
                    <span class="s1">&#39;nugent-sn1bc&#39;</span><span class="p">:{</span><span class="s1">&#39;z&#39;</span><span class="p">:(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)}}</span>
        
<div class="viewcode-block" id="TemplateFeatures.extract_features"><a class="viewcode-back" href="../../snfeatures.html#snmachine.snfeatures.TemplateFeatures.extract_features">[docs]</a>    <span class="k">def</span> <span class="nf">extract_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">save_chains</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">chain_directory</span><span class="o">=</span><span class="s1">&#39;chains&#39;</span><span class="p">,</span> <span class="n">use_redshift</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nprocesses</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">restart</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">seed</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract template features for a dataset.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        d : Dataset object</span>
<span class="sd">            Dataset</span>
<span class="sd">        save_chains : bool</span>
<span class="sd">            Whether or not to save the intermediate output (if Bayesian inference is used instead of least squares)</span>
<span class="sd">        chain_directory : str</span>
<span class="sd">            Where to save the chains</span>
<span class="sd">        use_redshift : bool</span>
<span class="sd">            Whether or not to use provided redshift when fitting objects</span>
<span class="sd">        nprocesses : int, optional</span>
<span class="sd">            Number of processors to use for parallelisation (shared memory only)</span>
<span class="sd">        restart : bool</span>
<span class="sd">            Whether or not to restart from multinest chains</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        astropy.table.Table</span>
<span class="sd">            Table of fitted model parameters.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s1">&#39;mkdir&#39;</span><span class="p">,</span> <span class="n">chain_directory</span><span class="p">])</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Fitting templates using&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampler</span><span class="p">,</span> <span class="s1">&#39;...&#39;</span><span class="p">)</span>
        <span class="n">all_output</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">t1</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">mod_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mod_name</span><span class="o">==</span><span class="s1">&#39;mlcs2k2&#39;</span><span class="p">:</span>
                <span class="n">dust</span><span class="o">=</span><span class="n">sncosmo</span><span class="o">.</span><span class="n">CCM89Dust</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">=</span><span class="n">sncosmo</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">templates</span><span class="p">[</span><span class="n">mod_name</span><span class="p">],</span><span class="n">effects</span><span class="o">=</span><span class="p">[</span><span class="n">dust</span><span class="p">],</span><span class="n">effect_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">],</span> <span class="n">effect_frames</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;rest&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">=</span><span class="n">sncosmo</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">templates</span><span class="p">[</span><span class="n">mod_name</span><span class="p">])</span>
            <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;[&#39;</span><span class="o">+</span><span class="n">mod_name</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="o">+</span><span class="n">pname</span> <span class="k">for</span> <span class="n">pname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">param_names</span><span class="p">]</span>
            <span class="c1"># err_plus=[pname+&#39;_err+&#39; for pname in params]</span>
            <span class="c1"># err_minus=[pname+&#39;_err-&#39; for pname in params]</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Object&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">params</span>
            <span class="c1"># if self.sampler==&#39;mcmc&#39;:</span>
            <span class="c1">#     labels=[&#39;Object&#39;]+params</span>
            <span class="c1"># elif self.sampler==&#39;nested&#39;:</span>
            <span class="c1">#     labels=[&#39;Object&#39;]+params</span>
            <span class="c1"># else:</span>
            <span class="c1">#     labels=[&#39;Object&#39;]+params+[&#39;Chisq&#39;]</span>
            
            <span class="c1">#output=Table(names=labels, dtype=[&#39;S32&#39;]+[&#39;f&#39;]*(len(labels)-1))</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">names</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;U32&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
            
            <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">if</span> <span class="n">nprocesses</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">object_names</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">k</span><span class="o">%</span><span class="mi">100</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                        <span class="nb">print</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s1">&#39;objects fitted&#39;</span><span class="p">)</span>
                    <span class="n">lc</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span>
                    
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampler</span><span class="o">==</span><span class="s1">&#39;mcmc&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">seed</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
                        <span class="n">res</span><span class="p">,</span> <span class="n">fitted_model</span> <span class="o">=</span> <span class="n">sncosmo</span><span class="o">.</span><span class="n">mcmc_lc</span><span class="p">(</span><span class="n">lc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">param_names</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">templates</span><span class="p">[</span><span class="n">mod_name</span><span class="p">]],</span> <span class="n">nwalkers</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">nsamples</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span> <span class="n">nburn</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
                        <span class="n">chain</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">samples</span>
                        <span class="k">if</span> <span class="n">save_chains</span><span class="p">:</span>
                            <span class="n">tab</span><span class="o">=</span><span class="n">Table</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">param_names</span><span class="p">)</span>
                            <span class="n">tab</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chain_directory</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_emcee_&#39;</span><span class="o">+</span><span class="n">mod_name</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
                        <span class="n">best</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampler</span><span class="o">==</span><span class="s1">&#39;nested&#39;</span><span class="p">:</span>
                        <span class="n">best</span><span class="o">=</span><span class="n">_run_multinest_templates</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">templates</span><span class="p">[</span><span class="n">mod_name</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">templates</span><span class="p">[</span><span class="n">mod_name</span><span class="p">]],</span> <span class="n">chain_directory</span><span class="o">=</span><span class="n">chain_directory</span><span class="p">,</span>  
                        <span class="n">nlp</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">convert_to_binary</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_redshift</span><span class="o">=</span><span class="n">use_redshift</span><span class="p">,</span> <span class="n">short_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">short_names</span><span class="p">[</span><span class="n">mod_name</span><span class="p">],</span> <span class="n">restart</span><span class="o">=</span><span class="n">restart</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
                        <span class="n">best</span><span class="o">=</span><span class="n">best</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampler</span><span class="o">==</span><span class="s1">&#39;leastsq&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">use_redshift</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">lc</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">])</span>
                            <span class="n">prms</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">param_names</span>
                            <span class="n">prms</span><span class="o">=</span><span class="n">prms</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                            <span class="n">bnds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">templates</span><span class="p">[</span><span class="n">mod_name</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="n">bnds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                            <span class="n">res</span><span class="p">,</span> <span class="n">fitted_model</span><span class="o">=</span><span class="n">sncosmo</span><span class="o">.</span><span class="n">fit_lc</span><span class="p">(</span><span class="n">lc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">vparam_names</span><span class="o">=</span><span class="n">prms</span><span class="p">,</span> 
                                <span class="n">bounds</span><span class="o">=</span><span class="n">bnds</span><span class="p">,</span> <span class="n">minsnr</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            
                            <span class="n">res</span><span class="p">,</span> <span class="n">fitted_model</span><span class="o">=</span><span class="n">sncosmo</span><span class="o">.</span><span class="n">fit_lc</span><span class="p">(</span><span class="n">lc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">vparam_names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">param_names</span><span class="p">,</span> 
                                <span class="n">bounds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">templates</span><span class="p">[</span><span class="n">mod_name</span><span class="p">]],</span> <span class="n">minsnr</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>               
                        <span class="n">best</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="c1">#+[res[&#39;chisq&#39;]]</span>
                    <span class="n">row</span><span class="o">=</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span><span class="o">+</span><span class="n">best</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                    <span class="n">k</span><span class="o">+=</span><span class="mi">1</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_output</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">all_output</span><span class="o">=</span><span class="n">output</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">all_output</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">all_output</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampler</span><span class="o">==</span><span class="s1">&#39;leastsq&#39;</span><span class="p">:</span>
                    <span class="n">p</span><span class="o">=</span><span class="n">Pool</span><span class="p">(</span><span class="n">nprocesses</span><span class="p">,</span> <span class="n">maxtasksperchild</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">partial_func</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">_run_leastsq_templates</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">d</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">templates</span><span class="p">[</span><span class="n">mod_name</span><span class="p">],</span> <span class="n">use_redshift</span><span class="o">=</span><span class="n">use_redshift</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">templates</span><span class="p">[</span><span class="n">mod_name</span><span class="p">]])</span>
                    <span class="n">out</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">partial_func</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">object_names</span><span class="p">)</span>
                    <span class="n">output</span><span class="o">=</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)):</span>
                        <span class="n">output</span><span class="o">=</span><span class="n">vstack</span><span class="p">((</span><span class="n">output</span><span class="p">,</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_output</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">all_output</span><span class="o">=</span><span class="n">output</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">all_output</span><span class="o">=</span><span class="n">vstack</span><span class="p">((</span><span class="n">all_output</span><span class="p">,</span> <span class="n">output</span><span class="p">))</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampler</span><span class="o">==</span><span class="s1">&#39;nested&#39;</span><span class="p">:</span>
                    <span class="n">p</span><span class="o">=</span><span class="n">Pool</span><span class="p">(</span><span class="n">nprocesses</span><span class="p">,</span> <span class="n">maxtasksperchild</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">partial_func</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">_run_multinest_templates</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">d</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">templates</span><span class="p">[</span><span class="n">mod_name</span><span class="p">],</span> <span class="n">bounds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">templates</span><span class="p">[</span><span class="n">mod_name</span><span class="p">]],</span> 
                    <span class="n">chain_directory</span><span class="o">=</span><span class="n">chain_directory</span><span class="p">,</span> <span class="n">nlp</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">convert_to_binary</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_redshift</span><span class="o">=</span><span class="n">use_redshift</span><span class="p">,</span> <span class="n">short_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">short_names</span><span class="p">[</span><span class="n">mod_name</span><span class="p">],</span> <span class="n">restart</span><span class="o">=</span><span class="n">restart</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
                    <span class="n">out</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">partial_func</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">object_names</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)):</span>
                        <span class="n">output</span><span class="o">.</span><span class="n">add_row</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">object_names</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">+</span><span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_output</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">all_output</span><span class="o">=</span><span class="n">output</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">all_output</span><span class="o">=</span><span class="n">vstack</span><span class="p">((</span><span class="n">all_output</span><span class="p">,</span> <span class="n">output</span><span class="p">))</span>
                        
        <span class="nb">print</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_output</span><span class="p">),</span> <span class="s1">&#39;objects fitted&#39;</span><span class="p">)</span>
        <span class="n">output_time</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">all_output</span></div>
        
        
<div class="viewcode-block" id="TemplateFeatures.fit_sn"><a class="viewcode-back" href="../../snfeatures.html#snmachine.snfeatures.TemplateFeatures.fit_sn">[docs]</a>    <span class="k">def</span> <span class="nf">fit_sn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lc</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fits the chosen template model to a given light curve.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lc : astropy.table.Table</span>
<span class="sd">            Light curve</span>
<span class="sd">        features : astropy.table.Table</span>
<span class="sd">            Model parameters</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        astropy.table.Table</span>
<span class="sd">            Fitted light curve</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obj</span><span class="o">=</span><span class="n">lc</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="n">tab</span><span class="o">=</span><span class="n">features</span><span class="p">[</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;Object&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">obj</span><span class="p">]</span>
        <span class="n">params</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tab</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tab</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
             
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;No feature set found for&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="n">model_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">templates</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">model_name</span><span class="o">==</span><span class="s1">&#39;mlcs2k2&#39;</span><span class="p">:</span>
            <span class="n">dust</span><span class="o">=</span><span class="n">sncosmo</span><span class="o">.</span><span class="n">CCM89Dust</span><span class="p">()</span>
            <span class="n">model</span><span class="o">=</span><span class="n">sncosmo</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span><span class="n">effects</span><span class="o">=</span><span class="p">[</span><span class="n">dust</span><span class="p">],</span><span class="n">effect_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">],</span> <span class="n">effect_frames</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;rest&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model</span><span class="o">=</span><span class="n">sncosmo</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
        
        <span class="n">param_dict</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param_names</span><span class="p">)):</span>
            <span class="n">param_dict</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">model</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="n">param_dict</span><span class="p">)</span>

        <span class="n">filts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">])</span>
        <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mjd&#39;</span><span class="p">,</span> <span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;filter&#39;</span><span class="p">]</span>
        <span class="n">output</span><span class="o">=</span><span class="n">Table</span><span class="p">(</span><span class="n">names</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;U32&#39;</span><span class="p">],</span>  <span class="n">meta</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="n">obj</span><span class="p">})</span>
        <span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="n">filts</span><span class="p">:</span>
            <span class="n">x</span><span class="o">=</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;mjd&#39;</span><span class="p">][</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">filt</span><span class="p">]</span>
            <span class="n">xnew</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">P</span><span class="o">=</span><span class="n">params</span>
            
            <span class="n">ynew</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">bandflux</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="n">xnew</span><span class="p">,</span> <span class="n">zp</span><span class="o">=</span><span class="mf">27.5</span><span class="p">,</span> <span class="n">zpsys</span><span class="o">=</span><span class="s1">&#39;ab&#39;</span><span class="p">)</span>

            <span class="n">newtable</span><span class="o">=</span><span class="n">Table</span><span class="p">([</span><span class="n">xnew</span><span class="o">+</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">ynew</span><span class="p">,</span> <span class="p">[</span><span class="n">filt</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">xnew</span><span class="p">)],</span> <span class="n">names</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
            <span class="c1">#newtable=Table([x, ynew, [filt]*len(x)], names=labels)</span>
            <span class="n">output</span><span class="o">=</span><span class="n">vstack</span><span class="p">((</span><span class="n">output</span><span class="p">,</span> <span class="n">newtable</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">output</span></div>

<div class="viewcode-block" id="TemplateFeatures.registerBands"><a class="viewcode-back" href="../../snfeatures.html#snmachine.snfeatures.TemplateFeatures.registerBands">[docs]</a>    <span class="k">def</span> <span class="nf">registerBands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register LSST bandpasses with sncosmo.</span>
<span class="sd">           Courtesy of Rahul Biswas&quot;&quot;&quot;</span>
        <span class="n">bands</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">bands</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">band</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="n">bp</span> <span class="o">=</span> <span class="n">sncosmo</span><span class="o">.</span><span class="n">Bandpass</span><span class="p">(</span><span class="n">wave</span><span class="o">=</span><span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">trans</span><span class="o">=</span><span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;lsst&#39;</span><span class="o">+</span><span class="n">band</span><span class="p">)</span>
            <span class="n">sncosmo</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div></div>
            
<div class="viewcode-block" id="ParametricFeatures"><a class="viewcode-back" href="../../snfeatures.html#snmachine.snfeatures.ParametricFeatures">[docs]</a><span class="k">class</span> <span class="nc">ParametricFeatures</span><span class="p">(</span><span class="n">Features</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fits a few options of generalised, parametric models to the data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_choice</span><span class="p">,</span> <span class="n">sampler</span><span class="o">=</span><span class="s1">&#39;leastsq&#39;</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialisation</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model_choice : str</span>
<span class="sd">            Which parametric model to use</span>
<span class="sd">        sampler : str, optional</span>
<span class="sd">            Choice of &#39;mcmc&#39; (requires emcee), &#39;nested&#39; (requires pymultinest) or &#39;leastsq&#39;</span>
<span class="sd">        limits : dict, optional</span>
<span class="sd">            Parameter bounds if something other than the default is needed.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">Features</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model_choices</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;newling&#39;</span><span class="p">:</span><span class="n">parametric_models</span><span class="o">.</span><span class="n">NewlingModel</span><span class="p">,</span> <span class="s1">&#39;karpenka&#39;</span><span class="p">:</span><span class="n">parametric_models</span><span class="o">.</span><span class="n">KarpenkaModel</span><span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="o">=</span><span class="n">model_choice</span> <span class="c1">#Used for labelling output files</span>
            <span class="k">if</span> <span class="n">limits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_choices</span><span class="p">[</span><span class="n">model_choice</span><span class="p">](</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_choices</span><span class="p">[</span><span class="n">model_choice</span><span class="p">]()</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Your selected model is not in the parametric_models package. Either choose an existing model,  or implement a new one in that package.&#39;</span><span class="p">)</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Make sure any new models are included in the model_choices dictionary in the ParametricFeatures class.&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
            
        <span class="k">if</span> <span class="n">sampler</span><span class="o">==</span><span class="s1">&#39;nested&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_multinest</span><span class="p">:</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Nested sampling selected but pymultinest is not installed. Defaulting to least squares.&#39;</span><span class="p">)</span>
            <span class="n">sampler</span><span class="o">=</span><span class="s1">&#39;leastsq&#39;</span>
                
        <span class="k">elif</span> <span class="n">sampler</span><span class="o">==</span><span class="s1">&#39;mcmc&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_emcee</span><span class="p">:</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;MCMC sampling selected but emcee is not installed. Defaulting to least squares.&#39;</span><span class="p">)</span>
            <span class="n">sampler</span><span class="o">=</span><span class="s1">&#39;leastsq&#39;</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">sampler</span><span class="o">=</span><span class="n">sampler</span>



<div class="viewcode-block" id="ParametricFeatures.extract_features"><a class="viewcode-back" href="../../snfeatures.html#snmachine.snfeatures.ParametricFeatures.extract_features">[docs]</a>    <span class="k">def</span> <span class="nf">extract_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">chain_directory</span><span class="o">=</span><span class="s1">&#39;chains&#39;</span><span class="p">,</span> <span class="n">save_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">n_attempts</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">nprocesses</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_walkers</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> 
    <span class="n">n_steps</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">walker_spread</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">burn</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">nlp</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">starting_point</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">convert_to_binary</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">restart</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">seed</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit parametric models and return best-fitting parameters as features.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        d : Dataset object</span>
<span class="sd">            Dataset</span>
<span class="sd">        chain_directory : str</span>
<span class="sd">            Where to save the chains</span>
<span class="sd">        save_output : bool</span>
<span class="sd">            Whether or not to save the intermediate output (if Bayesian inference is used instead of least squares)</span>
<span class="sd">        n_attempts : int</span>
<span class="sd">            Allow the minimiser to start in new random locations if the fit is bad. Put n_attempts=1 to fit only once</span>
<span class="sd">            with the default starting position.</span>
<span class="sd">        nprocesses : int, optional</span>
<span class="sd">            Number of processors to use for parallelisation (shared memory only)</span>
<span class="sd">        n_walkers : int</span>
<span class="sd">            emcee parameter - number of walkers to use</span>
<span class="sd">        n_steps : int</span>
<span class="sd">            emcee parameter - total number of steps</span>
<span class="sd">        walker_spread : float</span>
<span class="sd">            emcee parameter - standard deviation of distribution of starting points of walkers</span>
<span class="sd">        burn : int</span>
<span class="sd">            emcee parameter - length of burn-in</span>
<span class="sd">        nlp : int</span>
<span class="sd">            multinest parameter - number of live points</span>
<span class="sd">        starting_point : None or array-like</span>
<span class="sd">            Starting points of parameters for leastsq or emcee</span>
<span class="sd">        convert_to_binary : bool</span>
<span class="sd">            multinest parameter - whether or not to convert ascii output files to binary</span>
<span class="sd">        n_iter : int</span>
<span class="sd">            leastsq parameter - number of iterations to avoid local minima</span>
<span class="sd">        restart : bool</span>
<span class="sd">            Whether or not t restart from existing multinest chains</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        astropy.table.Table</span>
<span class="sd">            Best-fitting parameters</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s1">&#39;mkdir&#39;</span><span class="p">,</span> <span class="n">chain_directory</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chain_directory</span><span class="o">=</span><span class="n">chain_directory</span>
        <span class="n">t1</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">output</span><span class="o">=</span><span class="p">[]</span>
        
        <span class="c1">#obj=d.object_names[0]</span>
        <span class="k">if</span> <span class="n">nprocesses</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">object_names</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span><span class="o">%</span><span class="mi">100</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s1">&#39;objects fitted&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampler</span><span class="o">==</span><span class="s1">&#39;leastsq&#39;</span><span class="p">:</span>
                    <span class="n">newtable</span><span class="o">=</span><span class="n">_run_leastsq</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">n_attempts</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampler</span><span class="o">==</span><span class="s1">&#39;mcmc&#39;</span><span class="p">:</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">seed</span><span class="o">!=-</span><span class="mi">1</span><span class="p">):</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
                    <span class="n">newtable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run_emcee</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">save_output</span><span class="p">,</span> <span class="n">chain_directory</span><span class="p">,</span>   <span class="n">n_walkers</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">,</span> <span class="n">walker_spread</span><span class="p">,</span> <span class="n">burn</span><span class="p">,</span> <span class="n">starting_point</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">newtable</span><span class="o">=</span><span class="n">_run_multinest</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">chain_directory</span><span class="p">,</span> <span class="n">nlp</span><span class="p">,</span> <span class="n">convert_to_binary</span><span class="p">,</span> <span class="n">n_iter</span><span class="p">,</span> <span class="n">restart</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">output</span><span class="o">=</span><span class="n">newtable</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">output</span><span class="o">=</span><span class="n">vstack</span><span class="p">((</span><span class="n">output</span><span class="p">,</span> <span class="n">newtable</span><span class="p">))</span>
                <span class="n">k</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampler</span><span class="o">==</span><span class="s1">&#39;leastsq&#39;</span><span class="p">:</span>
                <span class="n">p</span><span class="o">=</span><span class="n">Pool</span><span class="p">(</span><span class="n">nprocesses</span><span class="p">,</span> <span class="n">maxtasksperchild</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">partial_func</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">_run_leastsq</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">d</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>  <span class="n">n_attempts</span><span class="o">=</span><span class="n">n_attempts</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
                <span class="n">out</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">partial_func</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">object_names</span><span class="p">)</span>
                <span class="n">output</span><span class="o">=</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)):</span>
                    <span class="n">output</span><span class="o">=</span><span class="n">vstack</span><span class="p">((</span><span class="n">output</span><span class="p">,</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampler</span><span class="o">==</span><span class="s1">&#39;nested&#39;</span><span class="p">:</span>
                <span class="n">p</span><span class="o">=</span><span class="n">Pool</span><span class="p">(</span><span class="n">nprocesses</span><span class="p">,</span> <span class="n">maxtasksperchild</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">partial_func</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">_run_multinest</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">d</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span><span class="n">chain_directory</span><span class="o">=</span><span class="n">chain_directory</span><span class="p">,</span> 
                <span class="n">nlp</span><span class="o">=</span><span class="n">nlp</span><span class="p">,</span> <span class="n">convert_to_binary</span><span class="o">=</span><span class="n">convert_to_binary</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="n">n_iter</span><span class="p">,</span> <span class="n">restart</span><span class="o">=</span><span class="n">restart</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
                <span class="c1">#Pool starts a number of threads, all of which may try to tackle all of the data. Better to take it in chunks</span>
                <span class="n">output</span><span class="o">=</span><span class="p">[]</span>
                <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
                <span class="n">objs</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">object_names</span>
                <span class="k">while</span> <span class="n">k</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">objs</span><span class="p">):</span>
                    <span class="n">objs_subset</span><span class="o">=</span><span class="n">objs</span><span class="p">[</span><span class="n">k</span><span class="p">:</span><span class="n">k</span><span class="o">+</span><span class="n">nprocesses</span><span class="p">]</span>
                    <span class="n">out</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">partial_func</span><span class="p">,</span> <span class="n">objs_subset</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
                            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Fitting failed for&#39;</span><span class="p">,</span> <span class="n">objs_subset</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                                <span class="n">output</span><span class="o">=</span><span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">output</span><span class="o">=</span><span class="n">vstack</span><span class="p">((</span><span class="n">output</span><span class="p">,</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                    <span class="n">k</span><span class="o">+=</span><span class="nb">len</span><span class="p">(</span><span class="n">objs_subset</span><span class="p">)</span>
        <span class="nb">print</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">),</span> <span class="s1">&#39;objects fitted&#39;</span><span class="p">)</span>
        <span class="n">output_time</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span></div>
        
        
<div class="viewcode-block" id="ParametricFeatures.fit_sn"><a class="viewcode-back" href="../../snfeatures.html#snmachine.snfeatures.ParametricFeatures.fit_sn">[docs]</a>    <span class="k">def</span> <span class="nf">fit_sn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lc</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fits the chosen parametric model to a given light curve.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lc : astropy.table.Table</span>
<span class="sd">            Light curve</span>
<span class="sd">        features : astropy.table.Table</span>
<span class="sd">            Model parameters</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        astropy.table.Table</span>
<span class="sd">            Fitted light curve</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obj</span><span class="o">=</span><span class="n">lc</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="n">params</span><span class="o">=</span><span class="n">features</span><span class="p">[</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;Object&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">obj</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;No feature set found for&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="n">filts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">])</span>
        <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mjd&#39;</span><span class="p">,</span> <span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;filter&#39;</span><span class="p">]</span>
        <span class="n">output</span><span class="o">=</span><span class="n">Table</span><span class="p">(</span><span class="n">names</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;U32&#39;</span><span class="p">],</span>  <span class="n">meta</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="n">obj</span><span class="p">})</span>
        <span class="n">cols</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">prms</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">params</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="n">filts</span><span class="p">:</span>
            <span class="n">x</span><span class="o">=</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;mjd&#39;</span><span class="p">][</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">filt</span><span class="p">]</span>
            <span class="n">xnew</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="mi">100</span><span class="p">)</span>
            
            <span class="c1">#inds=[s for s in cols if filt in s]</span>
            <span class="n">inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">([</span><span class="n">filt</span> <span class="ow">in</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">P</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">prms</span><span class="p">[</span><span class="n">inds</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>

            <span class="n">ynew</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">xnew</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>
            <span class="n">newtable</span><span class="o">=</span><span class="n">Table</span><span class="p">([</span><span class="n">xnew</span><span class="o">+</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">ynew</span><span class="p">,</span> <span class="p">[</span><span class="n">filt</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">xnew</span><span class="p">)],</span> <span class="n">names</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
            <span class="n">output</span><span class="o">=</span><span class="n">vstack</span><span class="p">((</span><span class="n">output</span><span class="p">,</span> <span class="n">newtable</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">output</span></div>
        

        
<div class="viewcode-block" id="ParametricFeatures.run_emcee"><a class="viewcode-back" href="../../snfeatures.html#snmachine.snfeatures.ParametricFeatures.run_emcee">[docs]</a>    <span class="k">def</span> <span class="nf">run_emcee</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">save_output</span><span class="p">,</span> <span class="n">chain_directory</span><span class="p">,</span>  <span class="n">n_walkers</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">,</span> <span class="n">walker_spread</span><span class="p">,</span> <span class="n">burn</span><span class="p">,</span> <span class="n">starting_point</span><span class="p">,</span> <span class="n">seed</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs emcee on all the filter bands of a given light curve, fitting the model to each one and extracting the best fitting parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        d : Dataset object</span>
<span class="sd">            Dataset</span>
<span class="sd">        obj : str</span>
<span class="sd">            Object name</span>
<span class="sd">        save_output : bool</span>
<span class="sd">            Whether or not to save the intermediate output</span>
<span class="sd">        chain_directory : str</span>
<span class="sd">            Where to save the chains</span>
<span class="sd">        n_walkers : int</span>
<span class="sd">            emcee parameter - number of walkers to use</span>
<span class="sd">        n_steps : int</span>
<span class="sd">            emcee parameter - total number of steps</span>
<span class="sd">        walker_spread : float</span>
<span class="sd">            emcee parameter - standard deviation of distribution of starting points of walkers</span>
<span class="sd">        burn : int</span>
<span class="sd">            emcee parameter - length of burn-in</span>
<span class="sd">        starting_point : None or array-like</span>
<span class="sd">            Starting points of parameters</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        astropy.table.Table</span>
<span class="sd">            Best fitting parameters (at the maximum posterior)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">get_params</span><span class="p">(</span><span class="n">starting_point</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">filt</span><span class="p">):</span>
            <span class="c1">#Helper function to get parameters from the features astropy table</span>
            <span class="n">X</span><span class="o">=</span><span class="n">starting_point</span><span class="p">[</span><span class="n">starting_point</span><span class="p">[</span><span class="s1">&#39;Object&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">obj</span><span class="p">]</span>
            <span class="n">cols</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span>
            <span class="n">inds</span><span class="o">=</span><span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">cols</span> <span class="k">if</span> <span class="n">filt</span> <span class="ow">in</span> <span class="n">s</span><span class="p">]</span>
            <span class="n">P</span><span class="o">=</span><span class="n">X</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span>
            <span class="n">P</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">P</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">P</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">P</span>
        
        <span class="n">lc</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span>
        <span class="n">filts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">])</span>
        
        <span class="k">if</span><span class="p">(</span><span class="n">seed</span><span class="o">!=-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

        <span class="n">n_params</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">param_names</span><span class="p">)</span>
        
        <span class="c1">#err_plus=[pname+&#39;_err+&#39; for pname in self.model.param_names]</span>
        <span class="c1">#err_minus=[pname+&#39;_err-&#39; for pname in self.model.param_names]</span>
        <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Object&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">filter_set</span><span class="p">:</span>
            <span class="n">pams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">param_names</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pams</span><span class="p">:</span>
                <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">+</span><span class="s1">&#39;-&#39;</span><span class="o">+</span><span class="n">p</span><span class="p">)</span>

        <span class="n">output</span><span class="o">=</span><span class="n">Table</span><span class="p">(</span><span class="n">names</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;U32&#39;</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">t1</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">row</span><span class="o">=</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">filter_set</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filts</span><span class="p">:</span>
                <span class="c1">#This is pretty specific to current setup</span>
                <span class="n">chain_name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain_directory</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">))</span>
                
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;mjd&#39;</span><span class="p">][</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">f</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">][</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">f</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;flux_error&#39;</span><span class="p">][</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">f</span><span class="p">])</span>
                
                
                <span class="k">if</span> <span class="n">starting_point</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1">#Initialise randomly in parameter space</span>
                    <span class="n">iniparams</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">n_params</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">upper_limit</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">)</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">lower_limit</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">#A starting point from a least squares run can be given as an astropy table</span>
                    <span class="n">iniparams</span><span class="o">=</span><span class="n">get_params</span><span class="p">(</span><span class="n">starting_point</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                
                <span class="n">pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">iniparams</span> <span class="o">+</span> <span class="n">walker_spread</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_params</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_walkers</span><span class="p">)]</span>
                
                <span class="n">sampler</span> <span class="o">=</span> <span class="n">emcee</span><span class="o">.</span><span class="n">EnsembleSampler</span><span class="p">(</span><span class="n">n_walkers</span><span class="p">,</span> <span class="n">n_params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lnprob_emcee</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">yerr</span><span class="p">))</span>
                <span class="n">pos</span><span class="p">,</span> <span class="n">prob</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">run_mcmc</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">burn</span><span class="p">)</span> <span class="c1">#Remove burn-in</span>
                <span class="n">sampler</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
                <span class="n">pos</span><span class="p">,</span> <span class="n">prob</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">run_mcmc</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">)</span>
                
                <span class="n">samples</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">flatchain</span>
                <span class="n">lnpost</span><span class="o">=</span><span class="n">sampler</span><span class="o">.</span><span class="n">flatlnprobability</span>
                
                <span class="k">if</span> <span class="n">save_output</span><span class="p">:</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">chain_directory</span><span class="o">+</span><span class="s1">&#39;emcee_chain_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)(</span><span class="n">obj</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">samples</span><span class="p">,</span> <span class="n">lnpost</span><span class="p">)))</span>
                <span class="c1">#Maximum posterior params</span>
                <span class="n">ind</span><span class="o">=</span><span class="n">lnpost</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
                <span class="n">best_params</span><span class="o">=</span><span class="n">samples</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="p">:]</span>
                
                <span class="c1">#Expects first the parameters, then -sigma then +sigma</span>
                <span class="n">row</span><span class="o">+=</span><span class="n">best_params</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">row</span><span class="o">+=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">param_names</span><span class="p">)</span> <span class="c1">#I&#39;m not sure if it makes the most sense to fill in missing values with zeroes...</span>
        <span class="n">output</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Time per filter&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">filter_set</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">output</span></div>
    

<div class="viewcode-block" id="ParametricFeatures.lnprob_emcee"><a class="viewcode-back" href="../../snfeatures.html#snmachine.snfeatures.ParametricFeatures.lnprob_emcee">[docs]</a>    <span class="k">def</span> <span class="nf">lnprob_emcee</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">yerr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Likelihood function for emcee</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        params</span>
<span class="sd">        x</span>
<span class="sd">        y</span>
<span class="sd">        yerr</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Uniform prior. Directly compares arrays</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">params</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">params</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">)):</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ynew</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
            <span class="n">chi2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">ynew</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">ynew</span><span class="p">)</span><span class="o">/</span><span class="n">yerr</span><span class="o">/</span><span class="n">yerr</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">chi2</span><span class="o">/</span><span class="mf">2.</span></div></div>
        
        
<div class="viewcode-block" id="WaveletFeatures"><a class="viewcode-back" href="../../snfeatures.html#snmachine.snfeatures.WaveletFeatures">[docs]</a><span class="k">class</span> <span class="nc">WaveletFeatures</span><span class="p">(</span><span class="n">Features</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Uses wavelets to decompose the data and then reduces dimensionality of the feature space using PCA.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavelet</span><span class="o">=</span><span class="s1">&#39;sym2&#39;</span><span class="p">,</span> <span class="n">ngp</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialises the pywt wavelet object and sets the maximum depth for deconstruction.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        wavelet : str, optional</span>
<span class="sd">            String for which wavelet family to use.</span>
<span class="sd">        ngp : int, optional</span>
<span class="sd">            Number of points on the Gaussian process curve</span>
<span class="sd">        level : int, optional</span>
<span class="sd">            The maximum depth for wavelet deconstruction. If not provided, will use the maximum depth possible</span>
<span class="sd">            given the number of points in the Gaussian process curve.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Features</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">wav</span><span class="o">=</span><span class="n">pywt</span><span class="o">.</span><span class="n">Wavelet</span><span class="p">(</span><span class="n">wavelet</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ngp</span><span class="o">=</span><span class="n">ngp</span> <span class="c1">#Number of points to use on the Gaussian process curve</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wavelet_list</span><span class="o">=</span><span class="n">pywt</span><span class="o">.</span><span class="n">wavelist</span><span class="p">()</span> <span class="c1">#All possible families</span>

        <span class="k">if</span> <span class="n">wavelet</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">wavelet_list</span><span class="p">:</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Wavelet not recognised in pywt&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

        <span class="c1">#If the user does not specify a level of depth for the wavelet, automatically calculate it</span>
        <span class="k">if</span> <span class="s1">&#39;level&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mlev</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mlev</span><span class="o">=</span><span class="n">pywt</span><span class="o">.</span><span class="n">swt_max_level</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngp</span><span class="p">)</span>


<div class="viewcode-block" id="WaveletFeatures.extract_features"><a class="viewcode-back" href="../../snfeatures.html#snmachine.snfeatures.WaveletFeatures.extract_features">[docs]</a>    <span class="k">def</span> <span class="nf">extract_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">initheta</span><span class="o">=</span><span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="mi">20</span><span class="p">],</span> <span class="n">save_output</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span><span class="n">output_root</span><span class="o">=</span><span class="s1">&#39;features&#39;</span><span class="p">,</span> <span class="n">nprocesses</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">restart</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">gpalgo</span><span class="o">=</span><span class="s1">&#39;george&#39;</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies a wavelet transform followed by PCA dimensionality reduction to extract wavelet coefficients as features.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        d : Dataset object</span>
<span class="sd">            Dataset</span>
<span class="sd">        initheta: list-like, optional</span>
<span class="sd">            Initial values for theta parameters. These should be roughly the scale length in the y &amp; x directions.</span>
<span class="sd">        save_output : bool, optional</span>
<span class="sd">            Whether or not to save the output</span>
<span class="sd">        output_root : str, optional</span>
<span class="sd">         Output directory</span>
<span class="sd">        nprocesses : int, optional</span>
<span class="sd">            Number of processors to use for parallelisation (shared memory only)</span>
<span class="sd">        restart : str, optional</span>
<span class="sd">            Either &#39;none&#39; to start from scratch, &#39;gp&#39; to restart from saved Gaussian processes, or &#39;wavelet&#39; to</span>
<span class="sd">            restart from saved wavelet decompositions (will look in output_root for the previously saved outputs).</span>
<span class="sd">        log : bool, optional</span>
<span class="sd">            Whether or not to take the logarithm of the final PCA components. Recommended setting is False (legacy code).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        astropy.table.Table</span>
<span class="sd">            Table of features (first column object names, the rest are the PCA coefficient values)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">save_output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s1">&#39;mkdir&#39;</span><span class="p">,</span> <span class="n">output_root</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">xmin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xmin</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">if</span> <span class="n">xmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xmax</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">get_max_length</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">restart</span><span class="o">==</span><span class="s1">&#39;wavelet&#39;</span><span class="p">:</span>
            <span class="n">wavout</span><span class="p">,</span> <span class="n">waveout_err</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">restart_from_wavelets</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">output_root</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">restart</span><span class="o">==</span><span class="s1">&#39;gp&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">restart_from_gp</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">output_root</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">extract_GP</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngp</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">initheta</span><span class="p">,</span> <span class="n">save_output</span><span class="p">,</span> <span class="n">output_root</span><span class="p">,</span> <span class="n">nprocesses</span><span class="p">,</span> <span class="n">gpalgo</span><span class="o">=</span><span class="n">gpalgo</span><span class="p">)</span>

            <span class="n">wavout</span><span class="p">,</span> <span class="n">waveout_err</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_wavelets</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wav</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlev</span><span class="p">,</span>  <span class="n">nprocesses</span><span class="p">,</span> <span class="n">save_output</span><span class="p">,</span> <span class="n">output_root</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">,</span><span class="n">vals</span><span class="p">,</span><span class="n">vec</span><span class="p">,</span><span class="n">mn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_pca</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">object_names</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">wavout</span><span class="p">)</span>

        <span class="c1">#Save the PCA information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PCA_eigenvals</span> <span class="o">=</span> <span class="n">vals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PCA_eigenvectors</span><span class="o">=</span><span class="n">vec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PCA_mean</span><span class="o">=</span><span class="n">mn</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span></div>


<div class="viewcode-block" id="WaveletFeatures.fit_sn"><a class="viewcode-back" href="../../snfeatures.html#snmachine.snfeatures.WaveletFeatures.fit_sn">[docs]</a>    <span class="k">def</span> <span class="nf">fit_sn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lc</span><span class="p">,</span> <span class="n">comps</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span>  <span class="n">mn</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">filter_set</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fits a single object using previously run PCA components. Performs the full inverse wavelet transform.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lc : astropy.table.Table</span>
<span class="sd">            Light curve</span>
<span class="sd">        comps : astropy.table.Table</span>
<span class="sd">            The PCA coefficients for each object (i.e. the astropy table of wavelet features from by extract_features).</span>
<span class="sd">        vec : array-like</span>
<span class="sd">            PCA component vectors as array (each column is a vector, ordered from most to least significant)</span>
<span class="sd">        mn : array-like</span>
<span class="sd">            Mean vector</span>
<span class="sd">        xmin : float</span>
<span class="sd">            The minimum on the x axis (as defined for the original GP decomposition)</span>
<span class="sd">        xmax : float</span>
<span class="sd">            The maximum on the x axis (as defined for the original GP decomposition)</span>
<span class="sd">        filter_set : list-like</span>
<span class="sd">            The full set of filters of the original dataset</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        astropy.table.Table</span>
<span class="sd">            Fitted light curve</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">obj</span><span class="o">=</span><span class="n">lc</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="n">filts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">])</span>
        <span class="c1">#The PCA will have been done over the full coefficient set, across all filters</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pca_comps</span><span class="o">=</span><span class="n">comps</span><span class="p">[</span><span class="n">comps</span><span class="p">[</span><span class="s1">&#39;Object&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">obj</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;No feature set found for&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">new_comps</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pca_comps</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pca_comps</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">ncomp</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">new_comps</span><span class="p">)</span>
        <span class="n">eigs</span><span class="o">=</span><span class="n">vec</span><span class="p">[:,</span> <span class="p">:</span><span class="n">ncomp</span><span class="p">]</span>

        <span class="n">coeffs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">new_comps</span><span class="p">,</span> <span class="n">eigs</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">+</span><span class="n">mn</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mlev</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ngp</span>
        <span class="n">xnew</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngp</span><span class="p">)</span>
        <span class="n">output</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filter_set</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">filter_set</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">filts</span><span class="p">:</span>
                <span class="n">filt_coeffs</span><span class="o">=</span><span class="n">coeffs</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">n</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">n</span><span class="p">]</span>
                <span class="n">filt_coeffs</span><span class="o">=</span><span class="n">filt_coeffs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mlev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngp</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
                <span class="n">ynew</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">iswt</span><span class="p">(</span><span class="n">filt_coeffs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wav</span><span class="p">)</span>

                <span class="n">newtable</span><span class="o">=</span><span class="n">Table</span><span class="p">([</span><span class="n">xnew</span><span class="p">,</span> <span class="n">ynew</span><span class="p">,</span> <span class="p">[</span><span class="n">filter_set</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ngp</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mjd&#39;</span><span class="p">,</span> <span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;filter&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;U32&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">output</span><span class="o">=</span><span class="n">newtable</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">output</span><span class="o">=</span><span class="n">vstack</span><span class="p">((</span><span class="n">output</span><span class="p">,</span> <span class="n">newtable</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">output</span></div>


<div class="viewcode-block" id="WaveletFeatures.restart_from_gp"><a class="viewcode-back" href="../../snfeatures.html#snmachine.snfeatures.WaveletFeatures.restart_from_gp">[docs]</a>    <span class="k">def</span> <span class="nf">restart_from_gp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">output_root</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Allows the restarted of the feature extraction process from previously saved Gaussian Process curves.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        d : Dataset object</span>
<span class="sd">            The same dataset (object) on which the previous GP analysis was performed.</span>
<span class="sd">        output_root : str</span>
<span class="sd">            Location of GP objects</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Restarting from stored Gaussian Processes...&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">object_names</span><span class="p">:</span>
            <span class="n">fname</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_root</span><span class="p">,</span> <span class="s1">&#39;gp_&#39;</span><span class="o">+</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tab</span><span class="o">=</span><span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
                <span class="n">d</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span><span class="o">=</span><span class="n">tab</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;IOError, file &#39;</span><span class="p">,</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;does not exist.&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="WaveletFeatures.restart_from_wavelets"><a class="viewcode-back" href="../../snfeatures.html#snmachine.snfeatures.WaveletFeatures.restart_from_wavelets">[docs]</a>    <span class="k">def</span> <span class="nf">restart_from_wavelets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">output_root</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Allows the restarted of the feature extraction process from previously saved wavelet decompositions. This</span>
<span class="sd">        allows you to quickly try different dimensionality reduction (e.g. PCA) algorithms on the wavelets.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        d : Dataset object</span>
<span class="sd">            The same dataset (object) on which the previous wavelet analysis was performed.</span>
<span class="sd">        output_root : str</span>
<span class="sd">            Location of previously decomposed wavelet coefficients</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        wavout : array</span>
<span class="sd">            A numpy array of the wavelet coefficients where each row is an object and each column a different coefficient</span>
<span class="sd">        wavout_err :  array</span>
<span class="sd">            A similar numpy array storing the (assuming Gaussian) error on each coefficient.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Restarting from stored wavelets...&#39;</span><span class="p">)</span>
        <span class="n">nfilts</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">filter_set</span><span class="p">)</span>
        <span class="n">wavout</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">object_names</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngp</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mlev</span><span class="o">*</span><span class="n">nfilts</span><span class="p">])</span> <span class="c1">#This is just a very big array holding coefficients in memory</span>
        <span class="n">wavout_err</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">object_names</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngp</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mlev</span><span class="o">*</span><span class="n">nfilts</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">object_names</span><span class="p">)):</span>
            <span class="n">obj</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">object_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">fname</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_root</span><span class="p">,</span> <span class="s1">&#39;wavelet_&#39;</span><span class="o">+</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">out</span><span class="o">=</span><span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
                <span class="n">cols</span><span class="o">=</span><span class="n">out</span><span class="o">.</span><span class="n">colnames</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ngp</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mlev</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nfilts</span><span class="p">):</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">out</span><span class="p">[</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">d</span><span class="o">.</span><span class="n">filter_set</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span>
                    <span class="n">coeffs</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">cols</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">mlev</span><span class="o">*</span><span class="mi">2</span><span class="p">]]</span>
                    <span class="n">coeffs_err</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">cols</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mlev</span><span class="o">*</span><span class="mi">2</span><span class="p">:]]</span>
                    <span class="n">newcoeffs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">coeffs</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">coeffs</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
                    <span class="n">newcoeffs_err</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">coeffs_err</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">coeffs_err</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
                    <span class="n">wavout</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">*</span><span class="n">n</span><span class="p">:(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">n</span><span class="p">]</span><span class="o">=</span><span class="n">newcoeffs</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
                    <span class="n">wavout_err</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">*</span><span class="n">n</span><span class="p">:(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">n</span><span class="p">]</span><span class="o">=</span><span class="n">newcoeffs_err</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;IOError, file &#39;</span><span class="p">,</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;does not exist.&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">wavout</span><span class="p">,</span> <span class="n">wavout_err</span></div>

<div class="viewcode-block" id="WaveletFeatures.extract_GP"><a class="viewcode-back" href="../../snfeatures.html#snmachine.snfeatures.WaveletFeatures.extract_GP">[docs]</a>    <span class="k">def</span> <span class="nf">extract_GP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">ngp</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">initheta</span><span class="p">,</span> <span class="n">save_output</span><span class="p">,</span>  <span class="n">output_root</span><span class="p">,</span> <span class="n">nprocesses</span><span class="p">,</span> <span class="n">gpalgo</span><span class="o">=</span><span class="s1">&#39;george&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs Gaussian process code on entire dataset. The result is stored inside the models attribute of the dataset object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        d : Dataset object</span>
<span class="sd">            Dataset</span>
<span class="sd">        ngp : int</span>
<span class="sd">            Number of points to evaluate Gaussian Process at</span>
<span class="sd">        xmin : float</span>
<span class="sd">            Minimim time to evaluate at</span>
<span class="sd">        xmax : float</span>
<span class="sd">            Maximum time to evaluate at</span>
<span class="sd">        initheta : list-like</span>
<span class="sd">            Initial values for theta parameters. These should be roughly the scale length in the y &amp; x directions.</span>
<span class="sd">        save_output : bool</span>
<span class="sd">            Whether or not to save the output</span>
<span class="sd">        output_root : str</span>
<span class="sd">            Output directory</span>
<span class="sd">        nprocesses : int, optional</span>
<span class="sd">            Number of processors to use for parallelisation (shared memory only)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Performing Gaussian process regression&#39;</span><span class="p">)</span>
        <span class="n">t1</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1">#Check for parallelisation</span>
        <span class="k">if</span> <span class="n">nprocesses</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">object_names</span><span class="p">)):</span>
                <span class="n">obj</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">object_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">out</span><span class="o">=</span><span class="n">_GP</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">d</span><span class="p">,</span><span class="n">ngp</span><span class="o">=</span><span class="n">ngp</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="n">xmax</span><span class="p">,</span> <span class="n">initheta</span><span class="o">=</span><span class="n">initheta</span><span class="p">,</span> <span class="n">save_output</span><span class="o">=</span><span class="n">save_output</span><span class="p">,</span> <span class="n">output_root</span><span class="o">=</span><span class="n">output_root</span><span class="p">,</span> <span class="n">gpalgo</span><span class="o">=</span><span class="n">gpalgo</span><span class="p">)</span>
                <span class="n">d</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span><span class="o">=</span><span class="n">out</span>
                <span class="k">if</span> <span class="n">save_output</span><span class="o">!=</span><span class="s1">&#39;none&#39;</span><span class="p">:</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_root</span><span class="p">,</span> <span class="s1">&#39;gp_&#39;</span><span class="o">+</span><span class="n">obj</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span><span class="o">=</span><span class="n">Pool</span><span class="p">(</span><span class="n">nprocesses</span><span class="p">,</span> <span class="n">maxtasksperchild</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1">#Pool and map can only really work with single-valued functions</span>
            <span class="n">partial_GP</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">_GP</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">d</span><span class="p">,</span> <span class="n">ngp</span><span class="o">=</span><span class="n">ngp</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="n">xmax</span><span class="p">,</span> <span class="n">initheta</span><span class="o">=</span><span class="n">initheta</span><span class="p">,</span> <span class="n">save_output</span><span class="o">=</span><span class="n">save_output</span><span class="p">,</span> <span class="n">output_root</span><span class="o">=</span><span class="n">output_root</span><span class="p">,</span> <span class="n">gpalgo</span><span class="o">=</span><span class="n">gpalgo</span><span class="p">)</span>

            <span class="n">out</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">partial_GP</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">object_names</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)):</span>
                <span class="n">obj</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">object_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">d</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span><span class="o">=</span><span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Time taken for Gaussian process regression&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span></div>

<div class="viewcode-block" id="WaveletFeatures.GP"><a class="viewcode-back" href="../../snfeatures.html#snmachine.snfeatures.WaveletFeatures.GP">[docs]</a>    <span class="k">def</span> <span class="nf">GP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">ngp</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="mi">170</span><span class="p">,</span> <span class="n">initheta</span><span class="o">=</span><span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="mi">20</span><span class="p">],</span> <span class="n">gpalgo</span><span class="o">=</span><span class="s1">&#39;george&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit a Gaussian process curve at specific evenly spaced points along a light curve.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obj : str</span>
<span class="sd">            Object name</span>
<span class="sd">        d : Dataset object</span>
<span class="sd">            Dataset</span>
<span class="sd">        ngp / int, optional</span>
<span class="sd">            Number of points to evaluate Gaussian Process at</span>
<span class="sd">        xmin : float, optional</span>
<span class="sd">            Minimim time to evaluate at</span>
<span class="sd">        xmax : float, optional</span>
<span class="sd">            Maximum time to evaluate at</span>
<span class="sd">        initheta : list-like, optional</span>
<span class="sd">            Initial values for theta parameters. These should be roughly the scale length in the y &amp; x directions.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        astropy.table.Table</span>
<span class="sd">            Table with evaluated Gaussian process curve and errors</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Wraps internal module-level function in order to circumvent multiprocessing module limitations in dealing with</span>
<span class="sd">        objects when parallelising.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_GP</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">ngp</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">initheta</span><span class="p">,</span> <span class="n">gpalgo</span><span class="p">)</span></div>


<div class="viewcode-block" id="WaveletFeatures.wavelet_decomp"><a class="viewcode-back" href="../../snfeatures.html#snmachine.snfeatures.WaveletFeatures.wavelet_decomp">[docs]</a>    <span class="k">def</span> <span class="nf">wavelet_decomp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lc</span><span class="p">,</span> <span class="n">wav</span><span class="p">,</span> <span class="n">mlev</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform a wavelet decomposition on a single light curve.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lc : astropy.table.Table</span>
<span class="sd">            Light curve</span>
<span class="sd">        wav : str or swt.Wavelet object</span>
<span class="sd">            Which wavelet family to use</span>
<span class="sd">        mlev : int</span>
<span class="sd">            Max depth</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        astropy.table.Table</span>
<span class="sd">            Decomposed coefficients in each filter.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">filters</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">])</span>
        <span class="n">ngp</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">][</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">filters</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="c1">#Store the output in another astropy table</span>
        <span class="n">output</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">fil</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
            <span class="n">y</span><span class="o">=</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">][</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">fil</span><span class="p">]</span>
            <span class="n">err</span><span class="o">=</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;flux_error&#39;</span><span class="p">][</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">fil</span><span class="p">]</span>
            <span class="n">coeffs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pywt</span><span class="o">.</span><span class="n">swt</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">wav</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">mlev</span><span class="p">))</span>
            <span class="n">coeffs_err</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pywt</span><span class="o">.</span><span class="n">swt</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">wav</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">mlev</span><span class="p">))</span> <span class="c1">#This actual gives a slight overestimate of the error</span>

            <span class="c1">#Create the column names (follows pywt convention)</span>
            <span class="n">labels</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coeffs</span><span class="p">)):</span>
                <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;cA</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coeffs</span><span class="p">)</span><span class="o">-</span><span class="n">i</span><span class="p">))</span>
                <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;cD</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coeffs</span><span class="p">)</span><span class="o">-</span><span class="n">i</span><span class="p">))</span>

            <span class="c1">#For the erors</span>
            <span class="n">err_labels</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)):</span>
                <span class="n">err_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_err&#39;</span><span class="p">)</span>
            <span class="n">npoints</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">coeffs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">c</span><span class="o">=</span><span class="n">coeffs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">mlev</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">npoints</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="n">c_err</span><span class="o">=</span><span class="n">coeffs_err</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">mlev</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">npoints</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="n">newtable1</span><span class="o">=</span><span class="n">Table</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
            <span class="n">newtable2</span><span class="o">=</span><span class="n">Table</span><span class="p">(</span><span class="n">c_err</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">err_labels</span><span class="p">)</span>
            <span class="n">joined_table</span><span class="o">=</span><span class="n">hstack</span><span class="p">([</span><span class="n">newtable1</span><span class="p">,</span> <span class="n">newtable2</span><span class="p">])</span>
            <span class="c1">#Add the filters</span>
            <span class="n">joined_table</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">fil</span><span class="p">]</span><span class="o">*</span><span class="n">npoints</span>

            <span class="k">if</span> <span class="n">output</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">output</span><span class="o">=</span><span class="n">joined_table</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output</span><span class="o">=</span><span class="n">vstack</span><span class="p">((</span><span class="n">output</span><span class="p">,</span> <span class="n">joined_table</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">output</span></div>

<div class="viewcode-block" id="WaveletFeatures.extract_wavelets"><a class="viewcode-back" href="../../snfeatures.html#snmachine.snfeatures.WaveletFeatures.extract_wavelets">[docs]</a>    <span class="k">def</span> <span class="nf">extract_wavelets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">wav</span><span class="p">,</span> <span class="n">mlev</span><span class="p">,</span> <span class="n">nprocesses</span><span class="p">,</span> <span class="n">save_output</span><span class="p">,</span> <span class="n">output_root</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform wavelet decomposition on all objects in dataset. Output is stored as astropy table for each object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        d : Dataset object</span>
<span class="sd">            Dataset</span>
<span class="sd">        wav : str or swt.Wavelet object</span>
<span class="sd">            Which wavelet family to use</span>
<span class="sd">        mlev : int</span>
<span class="sd">            Max depth</span>
<span class="sd">        nprocesses : int, optional</span>
<span class="sd">            Number of processors to use for parallelisation (shared memory only)</span>
<span class="sd">        save_output : bool, optional</span>
<span class="sd">            Whether or not to save the output</span>
<span class="sd">        output_root : str, optional</span>
<span class="sd">         Output directory</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        wavout : array</span>
<span class="sd">            A numpy array of the wavelet coefficients where each row is an object and each column a different coefficient</span>
<span class="sd">        wavout_err :  array</span>
<span class="sd">            A numpy array storing the (assuming Gaussian) error on each coefficient.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Performing wavelet decomposition&#39;</span><span class="p">)</span>

        <span class="n">nfilts</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">filter_set</span><span class="p">)</span>
        <span class="n">wavout</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">object_names</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngp</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">mlev</span><span class="o">*</span><span class="n">nfilts</span><span class="p">])</span> <span class="c1">#This is just a big array holding coefficients in memory</span>
        <span class="n">wavout_err</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">object_names</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngp</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">mlev</span><span class="o">*</span><span class="n">nfilts</span><span class="p">])</span>
        <span class="n">t1</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">object_names</span><span class="p">)):</span>
            <span class="n">obj</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">object_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">lc</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span>
            <span class="n">out</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wavelet_decomp</span><span class="p">(</span><span class="n">lc</span><span class="p">,</span> <span class="n">wav</span><span class="p">,</span> <span class="n">mlev</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">save_output</span><span class="o">==</span><span class="s1">&#39;wavelet&#39;</span> <span class="ow">or</span> <span class="n">save_output</span><span class="o">==</span><span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_root</span><span class="p">,</span> <span class="s1">&#39;wavelet_&#39;</span><span class="o">+</span><span class="n">obj</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
            <span class="c1">#We go by filter, then by set of coefficients</span>
            <span class="n">cols</span><span class="o">=</span><span class="n">out</span><span class="o">.</span><span class="n">colnames</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ngp</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">mlev</span>
            <span class="n">filts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">lc</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nfilts</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">filter_set</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="ow">in</span> <span class="n">filts</span><span class="p">:</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">out</span><span class="p">[</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">d</span><span class="o">.</span><span class="n">filter_set</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span>
                    <span class="n">coeffs</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">cols</span><span class="p">[:</span><span class="n">mlev</span><span class="o">*</span><span class="mi">2</span><span class="p">]]</span>
                    <span class="n">coeffs_err</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">cols</span><span class="p">[</span><span class="n">mlev</span><span class="o">*</span><span class="mi">2</span><span class="p">:]]</span>
                    <span class="n">newcoeffs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">coeffs</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">coeffs</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
                    <span class="n">newcoeffs_err</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">coeffs_err</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">coeffs_err</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
                    <span class="n">wavout</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">*</span><span class="n">n</span><span class="p">:(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">n</span><span class="p">]</span><span class="o">=</span><span class="n">newcoeffs</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
                    <span class="n">wavout_err</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">*</span><span class="n">n</span><span class="p">:(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">n</span><span class="p">]</span><span class="o">=</span><span class="n">newcoeffs_err</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Time for wavelet decomposition&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">wavout</span><span class="p">,</span> <span class="n">wavout_err</span></div>


<div class="viewcode-block" id="WaveletFeatures.pca"><a class="viewcode-back" href="../../snfeatures.html#snmachine.snfeatures.WaveletFeatures.pca">[docs]</a>    <span class="k">def</span> <span class="nf">pca</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs PCA decomposition of a feature array X.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : array</span>
<span class="sd">            Array of features to perform PCA on.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        vals : list-like</span>
<span class="sd">            Ordered array of eigenvalues</span>
<span class="sd">        vec : array</span>
<span class="sd">            Ordered array of eigenvectors, where each column is an eigenvector.</span>
<span class="sd">        mn : array</span>
<span class="sd">            The mean of the dataset, which is subtracted before PCA is performed.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Although SVD is considerably more efficient than eigh, it seems more numerically unstable and results in many more components</span>
<span class="sd">        being required to adequately describe the dataset, at least for the wavelet feature sets considered.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#Find the normalised spectra</span>
        <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="n">mn</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">mn</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mn</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="o">-</span><span class="n">mn</span>

        <span class="n">nor</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">x_norm</span><span class="o">=</span><span class="n">X</span><span class="o">/</span><span class="n">nor</span>
<span class="c1">#</span>
<span class="c1">#        #Construct the covariance matrix</span>
        <span class="n">C</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x_norm</span><span class="p">,</span> <span class="n">x_norm</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="c1">#C=np.cov(X.T)</span>
        <span class="c1">#print C.shape</span>

        <span class="n">C</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mat</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
        <span class="n">vals</span><span class="p">,</span> <span class="n">vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>

        <span class="n">inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">vals</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">vals</span><span class="p">[</span><span class="n">inds</span><span class="p">],</span> <span class="n">vec</span><span class="p">[:,</span> <span class="n">inds</span><span class="p">],</span> <span class="n">mn</span></div>

<div class="viewcode-block" id="WaveletFeatures.best_coeffs"><a class="viewcode-back" href="../../snfeatures.html#snmachine.snfeatures.WaveletFeatures.best_coeffs">[docs]</a>    <span class="k">def</span> <span class="nf">best_coeffs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">0.98</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine the minimum number of PCA components required to adequately describe the dataset.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        vals : list-like</span>
<span class="sd">            List of eigenvalues (ordered largest to smallest)</span>
<span class="sd">        tol : float, optional</span>
<span class="sd">            How much &#39;energy&#39; or information must be retained in the dataset.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            The required number of coefficients to retain the requested amount of &quot;information&quot;.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tot</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
        <span class="n">tot2</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)):</span>
            <span class="n">tot2</span><span class="o">+=</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tot2</span><span class="o">&gt;=</span><span class="n">tol</span><span class="o">*</span><span class="n">tot</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">i</span>
                <span class="k">break</span>

        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;No dimensionality reduction achieved. All components of the PCA are required.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span></div>

<div class="viewcode-block" id="WaveletFeatures.project_pca"><a class="viewcode-back" href="../../snfeatures.html#snmachine.snfeatures.WaveletFeatures.project_pca">[docs]</a>    <span class="k">def</span> <span class="nf">project_pca</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">eig_vec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Project a vector onto a PCA axis (i.e. transform data to PCA space).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : array</span>
<span class="sd">            Vector of original data (for one object).</span>
<span class="sd">        eig_vec : array</span>
<span class="sd">            Array of eigenvectors, first column most significant.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        array</span>
<span class="sd">            Coefficients of eigen vectors</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">A</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mat</span><span class="p">(</span><span class="n">eig_vec</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mat</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">A</span><span class="p">)</span></div>


<div class="viewcode-block" id="WaveletFeatures.extract_pca"><a class="viewcode-back" href="../../snfeatures.html#snmachine.snfeatures.WaveletFeatures.extract_pca">[docs]</a>    <span class="k">def</span> <span class="nf">extract_pca</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_names</span><span class="p">,</span>  <span class="n">wavout</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dimensionality reduction of wavelet coefficients using PCA.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        object_names : list-like</span>
<span class="sd">            Object names corresponding to each row of the wavelet coefficient array.</span>
<span class="sd">        wavout : array</span>
<span class="sd">            Wavelet coefficient array, each row corresponds to an object, each column is a coefficient.</span>
<span class="sd">        log</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        astropy.table.Table</span>
<span class="sd">            Astropy table containing PCA features.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Running PCA...&#39;</span><span class="p">)</span>
        <span class="n">t1</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1">#We now run PCA on this big matrix</span>
        <span class="n">vals</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">mn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pca</span><span class="p">(</span><span class="n">wavout</span><span class="p">)</span>
        <span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="c1">#</span>
        <span class="c1"># np.savetxt(&#39;PCA_vals.txt&#39;, vals)</span>
        <span class="c1"># np.savetxt(&#39;PCA_vec.txt&#39;, vec)</span>
        <span class="c1"># np.savetxt(&#39;PCA_mean.txt&#39;, mn)</span>

        <span class="c1">#Actually fit the components</span>
        <span class="n">ncomp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">best_coeffs</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
        <span class="n">eigs</span><span class="o">=</span><span class="n">vec</span><span class="p">[:,</span> <span class="p">:</span><span class="n">ncomp</span><span class="p">]</span>
        <span class="n">comps</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">wavout</span><span class="p">),</span> <span class="n">ncomp</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wavout</span><span class="p">)):</span>
            <span class="n">coeffs</span><span class="o">=</span><span class="n">wavout</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">A</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_pca</span><span class="p">(</span><span class="n">coeffs</span><span class="o">-</span><span class="n">mn</span><span class="p">,</span> <span class="n">eigs</span><span class="p">)</span>
            <span class="n">comps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">A</span>
        <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;C</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncomp</span><span class="p">)]</span>
        <span class="n">wavs</span><span class="o">=</span><span class="n">Table</span><span class="p">(</span><span class="n">comps</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">object_names</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">object_names</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">objnames</span><span class="o">=</span><span class="n">Table</span><span class="p">(</span><span class="n">object_names</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Object&#39;</span><span class="p">])</span>
        <span class="n">wavs</span><span class="o">=</span><span class="n">hstack</span><span class="p">((</span><span class="n">objnames</span><span class="p">,</span> <span class="n">wavs</span><span class="p">))</span>
        <span class="c1">#wavs.write(&#39;wavelet_features.dat&#39;, format=&#39;ascii&#39;)</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Time for PCA&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wavs</span><span class="p">,</span><span class="n">vals</span><span class="p">,</span><span class="n">vec</span><span class="p">,</span><span class="n">mn</span></div>

<div class="viewcode-block" id="WaveletFeatures.iswt"><a class="viewcode-back" href="../../snfeatures.html#snmachine.snfeatures.WaveletFeatures.iswt">[docs]</a>    <span class="k">def</span> <span class="nf">iswt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coefficients</span><span class="p">,</span> <span class="n">wavelet</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs inverse wavelet transform.</span>
<span class="sd">        M. G. Marino to complement pyWavelets&#39; swt.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        coefficients : array</span>
<span class="sd">            approx and detail coefficients, arranged in level value</span>
<span class="sd">            exactly as output from swt:</span>
<span class="sd">            e.g. [(cA1, cD1), (cA2, cD2), ..., (cAn, cDn)]</span>
<span class="sd">        wavelet : str or swt.Wavelet</span>
<span class="sd">            Either the name of a wavelet or a Wavelet object</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        array</span>
<span class="sd">            The inverse transformed array</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">coefficients</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># Avoid modification of input data</span>

        <span class="c1">#num_levels, equivalent to the decomposition level, n</span>
        <span class="n">num_levels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coefficients</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_levels</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">step_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">last_index</span> <span class="o">=</span> <span class="n">step_size</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">cD</span> <span class="o">=</span> <span class="n">coefficients</span><span class="p">[</span><span class="n">num_levels</span> <span class="o">-</span> <span class="n">j</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">first</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">last_index</span><span class="p">):</span> <span class="c1"># 0 to last_index - 1</span>

                <span class="c1"># Getting the indices that we will transform</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cD</span><span class="p">),</span> <span class="n">step_size</span><span class="p">)</span>

                <span class="c1"># select the even indices</span>
                <span class="n">even_indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
                <span class="c1"># select the odd indices</span>
                <span class="n">odd_indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>

                <span class="c1"># perform the inverse dwt on the selected indices,</span>
                <span class="c1"># making sure to use periodic boundary conditions</span>
                <span class="n">x1</span> <span class="o">=</span> <span class="n">pywt</span><span class="o">.</span><span class="n">idwt</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="n">even_indices</span><span class="p">],</span> <span class="n">cD</span><span class="p">[</span><span class="n">even_indices</span><span class="p">],</span> <span class="n">wavelet</span><span class="p">,</span> <span class="s1">&#39;per&#39;</span><span class="p">)</span>
                <span class="n">x2</span> <span class="o">=</span> <span class="n">pywt</span><span class="o">.</span><span class="n">idwt</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="n">odd_indices</span><span class="p">],</span> <span class="n">cD</span><span class="p">[</span><span class="n">odd_indices</span><span class="p">],</span> <span class="n">wavelet</span><span class="p">,</span> <span class="s1">&#39;per&#39;</span><span class="p">)</span>

                <span class="c1"># perform a circular shift right</span>
                <span class="n">x2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                <span class="c1"># average and insert into the correct indices</span>
                <span class="n">output</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span> <span class="o">+</span> <span class="n">x2</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span>

        <span class="k">return</span> <span class="n">output</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Michelle Lochner, Robert Schuhmann, Jason McEwen, Hiranya Peiris, Rahul Biswas, Ofer Lahav, Johnny Holland, Max Winter.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0.0',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          
          SphinxRtdTheme.Navigation.enableSticky();
          
      });
  </script> 

</body>
</html>